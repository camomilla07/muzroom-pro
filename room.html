<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Muzroom Pro ‚Äî –ö–æ–º–Ω–∞—Ç–∞</title>
  <link rel="icon" href="/favicon.ico">
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <style>
    :root{
      --bg:#f5f7fb; --paper:#fff; --ink:#1e2430; --muted:#5b657a;
      --accent:#2e3543; --accent-weak:#e7eaf2; --ring:0 0 0 4px rgba(46,53,67,.15);
      --shadow:0 12px 28px rgba(16,20,32,.08); --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    header,footer{max-width:1100px;margin:0 auto;padding:16px 14px}
    header a{color:var(--ink);text-decoration:none;font-weight:700;display:flex;align-items:center;gap:10px}
    .logo{width:32px;height:32px;border-radius:999px;background:conic-gradient(from 210deg,#2e3543,#4a5469,#2e3543);display:grid;place-items:center;color:#fff}
    main{max-width:1100px;margin:0 auto;padding:12px 14px 28px;display:grid;gap:14px}
    .panel{background:var(--paper);border:1px solid var(--accent-weak);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:14px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f0f3fa;border:1px dashed #cdd5e6;border-radius:12px;padding:12px}
    .btn{appearance:none;border:none;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer;transition:.25s;outline:none}
    .btn:focus-visible{box-shadow:var(--ring)}
    .btn-main{background:var(--accent);color:#fff}
    .btn-main:hover{box-shadow:0 10px 18px rgba(46,53,67,.18);background:#262c38}
    .btn-ghost{background:#fff;border:1px solid var(--accent-weak);color:var(--ink)}
    .btn-ghost:hover{border-color:#cfd6e6;box-shadow:0 8px 16px rgba(46,53,67,.08) inset,0 6px 14px rgba(46,53,67,.10)}
    video,.audio{width:100%;background:#0b0f1a;border-radius:12px}

    /* –ü–ª–µ–π–ª–∏—Å—Ç */
    #playlist{display:grid;gap:10px}
    .track{display:grid;grid-template-columns:auto minmax(64px,1fr) 1fr auto;gap:10px;align-items:center;padding:10px;border:1px solid var(--accent-weak);border-radius:12px;background:#fafcff}
    .title{min-width:64px}
    @media(max-width:600px){ .title{max-width:64px;overflow:hidden;white-space:nowrap} }
    .bar{height:8px;background:#e8eef8;border-radius:6px;position:relative;overflow:hidden}
    .bar span{position:absolute;left:0;top:0;bottom:0;width:0;background:#2e3543}
    .vol{width:120px}
    .icon{width:18px;height:18px;display:block}
  </style>
</head>
<body>
  <header>
    <a href="/"><span class="logo">–ú</span> Muzroom Pro</a>
  </header>

  <main>
    <!-- –ü–∞–Ω–µ–ª—å —Å—Å—ã–ª–∫–∏ (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ —É –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è) -->
    <section class="panel" id="sharePanel" style="display:none">
      <div class="muted small" id="roleBadge"></div>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <div class="code" id="shareCode" style="flex:1">–ü–æ–∫–∞ –Ω–µ—Ç —Å—Å—ã–ª–∫–∏</div>
        <button class="btn btn-ghost" id="copyBtn" disabled>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
      </div>
    </section>

    <!-- –ü–ª–∞—à–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π -->
    <section class="panel" id="permBanner" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="muted">–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.</div>
          <div class="small muted" id="iosHint" style="display:none">–ï—Å–ª–∏ —Ä–∞–Ω—å—à–µ –∑–∞–ø—Ä–µ—Ç–∏–ª–∏: aA ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞ ‚Üí –ö–∞–º–µ—Ä–∞/–ú–∏–∫—Ä–æ—Ñ–æ–Ω ‚Üí –†–∞–∑—Ä–µ—à–∏—Ç—å ‚Üí –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</div>
        </div>
        <button class="btn btn-main" id="askBtn">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
      </div>
    </section>

    <!-- –°–µ—Ç–∫–∞ –≤–∏–¥–µ–æ -->
    <section class="grid">
      <div class="panel">
        <video id="remoteVideo" autoplay playsinline></video>
        <div class="muted small" id="remoteState" style="margin-top:6px">–û–∂–∏–¥–∞–Ω–∏–µ —É—á–µ–Ω–∏–∫–∞‚Ä¶</div>
      </div>
      <div class="panel">
        <video id="localVideo" autoplay playsinline muted></video>
        <div class="row" style="margin-top:10px">
          <button class="btn btn-main" id="micBtn">üéôÔ∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω: –í–∫–ª</button>
          <button class="btn btn-ghost" id="camBtn">üì∑ –ö–∞–º–µ—Ä–∞: –í–∫–ª</button>
        </div>
        <div class="row" style="margin-top:8px">
          <label><input id="musicMode" type="checkbox" checked> –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º (–±–µ–∑ —à—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏—è)</label>
          <label><input id="sidetone" type="checkbox"> –°–ª—ã—à–∞—Ç—å —Å–µ–±—è (–≤ –Ω–∞—É—à–Ω–∏–∫–∞—Ö)</label>
        </div>
        <audio id="monitor" class="audio" controls hidden></audio>
      </div>
    </section>

    <!-- –ê–£–î–ò–û -->
    <section class="panel">
      <div class="muted" style="margin-bottom:8px">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–∏ –∞—É–¥–∏–æ —Ñ–∞–π–ª—ã</div>
      <div class="row">
        <!-- —à–∏—Ä–æ–∫–∏–π accept –¥–ª—è iOS/Android -->
        <input id="filePicker" type="file" multiple
               accept="audio/mpeg,audio/mp3,audio/mp4,audio/x-m4a,audio/aac,audio/wav,audio/ogg,audio/webm,audio/*,video/quicktime">
        <button class="btn btn-ghost" id="clearList">–û—á–∏—Å—Ç–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç</button>
      </div>
      <div id="playlist" style="margin-top:10px"></div>

      <!-- —Å–∫—Ä—ã—Ç—ã–π –ø–ª–µ–µ—Ä -->
      <audio id="hiddenPlayer" crossorigin="anonymous" playsinline></audio>

      <!-- –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ -->
      <div class="row" style="margin-top:12px">
        <div class="muted small">–°–∫–æ—Ä–æ—Å—Ç—å:</div>
        <button id="speedDown" class="btn btn-ghost">‚è¨ –º–µ–¥–ª–µ–Ω–Ω–µ–µ</button>
        <button id="speedUp" class="btn btn-ghost">‚è´ –±—ã—Å—Ç—Ä–µ–µ</button>
        <button id="speedReset" class="btn btn-ghost">—Å–±—Ä–æ—Å</button>
        <div id="speedValue" class="muted small" style="min-width:56px">√ó1.00</div>
      </div>

      <div class="small muted" style="margin-top:6px">
        –°–º–µ–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤—ã—Å–æ—Ç—É (—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤—ã—à–µ/–Ω–∏–∂–µ –≤–º–µ—Å—Ç–µ —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é).
      </div>
    </section>

    <section class="panel">
      <div class="muted small">
        –°–æ–≤–µ—Ç: –µ—Å–ª–∏ —Å–≤—è–∑—å —Å–ª–∞–±–∞—è ‚Äî –≤—ã–∫–ª—é—á–∏—Ç–µ –∫–∞–º–µ—Ä—É, –∑–≤—É–∫ –±—É–¥–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ. –ù–∞ iPhone –∞—É–¥–∏–æ –Ω–∞—á–Ω—ë—Ç –∏–≥—Ä–∞—Ç—å –ø–æ—Å–ª–µ –≤–∞—à–µ–≥–æ –∫–ª–∏–∫–∞.
      </div>
    </section>
  </main>

  <footer class="row" style="justify-content:space-between">
    <div class="muted small">Muzroom Pro ‚Äî –æ–Ω–ª–∞–π–Ω-–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö —É—Ä–æ–∫–æ–≤</div>
    <div class="muted small">¬© 2025 Muzroom Pro ¬∑ <a href="/privacy.html">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a></div>
  </footer>

<script>
/* ====== –£—Ç–∏–ª–∏—Ç—ã / —Å–æ—Å—Ç–æ—è–Ω–∏–µ ====== */
const $ = id => document.getElementById(id);
const qp = new URLSearchParams(location.search);
const isHost = qp.has('host');
const joinId = qp.get('join') || null;
const GEN = () => Math.random().toString(36).slice(2,8).toUpperCase();

let localStream=null, remoteStream=null, peer=null, currentCall=null;
let musicEnabled=true, monitorStarted=false;

const isIOS = /iP(ad|hone|od)/.test(navigator.userAgent) ||
  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
if(isIOS) $('iosHint').style.display = 'block';

/* ====== –ú–µ–¥–∏–∞ ====== */
function getConstraints(){
  return {
    audio:{
      echoCancellation: !musicEnabled,
      noiseSuppression: !musicEnabled,
      autoGainControl: !musicEnabled,
      channelCount:1, sampleRate:48000
    },
    video:true
  };
}
async function getMedia(){
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  localStream = await navigator.mediaDevices.getUserMedia(getConstraints());
  $('localVideo').srcObject = localStream;
  return localStream;
}
function setMic(on){ localStream?.getAudioTracks().forEach(t=>t.enabled=on); $('micBtn').textContent=`üéôÔ∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω: ${on?'–í–∫–ª':'–í—ã–∫–ª'}`; }
function setCam(on){ localStream?.getVideoTracks().forEach(t=>t.enabled=on); $('camBtn').textContent=`üì∑ –ö–∞–º–µ—Ä–∞: ${on?'–í–∫–ª':'–í—ã–∫–ª'}`; }
function toggleSidetone(on){
  const a=$('monitor');
  if(on && !monitorStarted){ a.hidden=false; a.srcObject=localStream; a.muted=false; a.play().catch(()=>{}); monitorStarted=true; }
  if(!on && monitorStarted){ a.pause(); a.srcObject=null; a.hidden=true; monitorStarted=false; }
}

/* ====== –†–∞–∑—Ä–µ—à–µ–Ω–∏—è ====== */
async function checkPermissions(){
  if(!navigator.permissions){ $('permBanner').style.display='block'; return 'prompt'; }
  try{
    const m=await navigator.permissions.query({name:'microphone'});
    const c=await navigator.permissions.query({name:'camera'});
    if(m.state==='granted' && c.state==='granted') return 'granted';
    $('permBanner').style.display='block';
    return (m.state==='denied'||c.state==='denied')?'denied':'prompt';
  }catch{ $('permBanner').style.display='block'; return 'prompt'; }
}
async function requestAccess(){
  try{
    await getMedia();
    $('permBanner').style.display='none';
    setMic(true); setCam(true);
    await initPeerFlow();
  }catch(e){
    console.error(e);
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–Ω–µ–µ –∑–∞–ø—Ä–µ—Ç–∏–ª –ø–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω–æ ‚Äî Safari –ø–æ–∫–∞–∂–µ—Ç —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ—Ö–æ–¥ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø. –ï—Å–ª–∏ —Ä–∞–Ω–µ–µ –∑–∞–ø—Ä–µ—Ç–∏–ª–∏ ‚Äî Safari ‚Üí aA ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞ ‚Üí –†–∞–∑—Ä–µ—à–∏—Ç—å –∫–∞–º–µ—Ä—É –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω, –∑–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
  }
}
$('askBtn').addEventListener('click', requestAccess);

/* ====== PeerJS / –∑–≤–æ–Ω–æ–∫ ====== */
function showShare(code){
  $('sharePanel').style.display='block';
  const link=`${location.origin}/room.html?join=${encodeURIComponent(code)}`;
  $('shareCode').textContent=link;
  const btn=$('copyBtn');
  btn.disabled=false;
  btn.onclick=async()=>{
    try{ await navigator.clipboard.writeText(link); btn.textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úì'; setTimeout(()=>btn.textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É',1200);}
    catch{ const r=document.createRange(); r.selectNodeContents($('shareCode')); const s=window.getSelection(); s.removeAllRanges(); s.addRange(r); }
  };
}
function bindStreamHandlers(call){
  call.on('stream',rs=>{ remoteStream=rs; $('remoteVideo').srcObject=rs; $('remoteState').textContent='–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'; });
  call.on('close',()=>{$('remoteState').textContent='–°–≤—è–∑—å –∑–∞–∫–æ–Ω—á–µ–Ω–∞';});
  call.on('error',e=>{ console.error(e); $('remoteState').textContent='–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'; });
}
function bindHandlersAsHost(){
  peer.on('call', call=>{ currentCall=call; call.answer(localStream); bindStreamHandlers(call); });
}
async function initPeerFlow(){
  if(peer) return;
  peer = new Peer(); // –ø—É–±–ª–∏—á–Ω—ã–π –æ–±–ª–∞—á–Ω—ã–π PeerJS
  if(isHost){
    peer.on('open', id=>{
      const code = GEN(); peer.destroy(); peer = new Peer(code);
      peer.on('open', ()=> showShare(code));
      bindHandlersAsHost();
    });
  }else if(joinId){
    peer.on('open', ()=>{
      const call=peer.call(joinId, localStream);
      currentCall=call; bindStreamHandlers(call);
    });
  }else{
    location.href='/';
  }
}

/* ====== –ü–ª–µ–π–ª–∏—Å—Ç / –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ ====== */
const picker=$('filePicker'), list=$('playlist'), player=$('hiddenPlayer');
let dragging=null;
let speed=1.0;

function shortTitle(name){
  const base = name.split('/').pop().split('\\').pop();
  return (window.matchMedia('(max-width:600px)').matches && base.length>4) ? (base.slice(0,4)+'‚Ä¶') : base;
}
function fmtRate(r){ return '√ó' + r.toFixed(2); }

function renderItem(name, url){
  const row=document.createElement('div'); row.className='track';

  const pp=document.createElement('button'); pp.className='btn btn-ghost';
  const playSVG='<svg class="icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" fill="currentColor"/></svg>';
  const pauseSVG='<svg class="icon" viewBox="0 0 24 24"><path d="M6 5h4v14H6zM14 5h4v14h-4z" fill="currentColor"/></svg>';
  pp.innerHTML=playSVG;

  const title=document.createElement('div'); title.className='title'; title.textContent=shortTitle(name);

  const bar=document.createElement('div'); bar.className='bar';
  const fill=document.createElement('span'); bar.appendChild(fill);

  const vol=document.createElement('input'); vol.type='range'; vol.className='vol'; vol.min=0; vol.max=1; vol.step=0.01; vol.value=1;

  row.append(pp,title,bar,vol);
  list.appendChild(row);

  function sync(){
    if(player.src===url && player.duration>0){
      fill.style.width = `${(player.currentTime/player.duration)*100}%`;
      if(!player.paused) requestAnimationFrame(sync);
    }
  }
  function setTimeByX(clientX){
    const r=bar.getBoundingClientRect(); const x=Math.min(Math.max(clientX-r.left,0),r.width);
    const ratio=r.width?x/r.width:0; if(player.src===url && player.duration>0) player.currentTime=ratio*player.duration;
  }

  bar.addEventListener('pointerdown',e=>{ dragging=url; setTimeByX(e.clientX); });
  window.addEventListener('pointermove',e=>{ if(dragging===url) setTimeByX(e.clientX); });
  window.addEventListener('pointerup',()=>{ if(dragging===url) dragging=null; });

  pp.onclick = async ()=>{
    if (player.src!==url){ player.src=url; player.currentTime=0; }
    player.playbackRate = speed; player.volume = vol.value;
    if (player.paused){
      await player.play().catch(()=>{});
      // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–æ—Ä–æ–∂–∫—É —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É: —á–µ—Ä–µ–∑ WebAudio (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ)
      attachToCall(player);
      pp.innerHTML=pauseSVG; requestAnimationFrame(sync);
    }else{
      player.pause(); pp.innerHTML=playSVG;
    }
  };
  vol.oninput = ()=>{ if(player.src===url) player.volume=vol.value; };

  player.addEventListener('ended',()=>{ if(player.src===url) pp.innerHTML=playSVG; });
}

function attachToCall(mediaEl){
  // —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ –¥–ª—è –≤—Å–µ—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤: MediaElementSource ‚Üí MediaStreamDestination
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const src = ctx.createMediaElementSource(mediaEl);
  const dest = ctx.createMediaStreamDestination();
  src.connect(ctx.destination); // –ª–æ–∫–∞–ª—å–Ω–æ —Å–ª—ã—à–∞—Ç—å
  src.connect(dest);            // –≤ –∑–≤–æ–Ω–æ–∫
  const tr = dest.stream.getAudioTracks()[0];
  if(currentCall && tr){
    const pc = currentCall.peerConnection;
    // –¥–æ–±–∞–≤–∏–º –Ω–æ–≤—ã–π —Ç—Ä–µ–∫ (–µ—Å–ª–∏ —É–∂–µ –±—ã–ª ‚Äî –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–∏—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º)
    pc.addTrack(tr, dest.stream);
  }
}

picker.addEventListener('change', ()=>{
  // –∏–Ω–æ–≥–¥–∞ iOS —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç accept ‚Üí –º—ã –∏ —Ç–∞–∫ –±–µ—Ä—ë–º –≤—Å—ë –∏–∑ multiple
  list.innerHTML='';
  const files = Array.from(picker.files||[]);
  files.forEach(f=>{
    const url = URL.createObjectURL(f); // –¥–∞—ë—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ iOS/Android
    renderItem(f.name, url);
  });
});
$('clearList').onclick = ()=>{
  list.innerHTML = '';
  player.pause(); player.removeAttribute('src');
  if(picker.value) picker.value='';
};

/* –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –°–ö–û–†–û–°–¢–ò */
const speedValue=$('speedValue');
$('speedDown').onclick = ()=>{ speed = Math.max(0.25, +(speed - 0.05).toFixed(2)); speedValue.textContent=fmtRate(speed); player.playbackRate=speed; };
$('speedUp').onclick   = ()=>{ speed = Math.min(2.00,  +(speed + 0.05).toFixed(2)); speedValue.textContent=fmtRate(speed); player.playbackRate=speed; };
$('speedReset').onclick= ()=>{ speed = 1.00; speedValue.textContent=fmtRate(speed); player.playbackRate=speed; };

/* ====== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ====== */
(async function init(){
  $('roleBadge').textContent = isHost ? '–í—ã ‚Äî –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å' : '–í—ã ‚Äî —É—á–µ–Ω–∏–∫';
  if (isHost) $('sharePanel').style.display='block';

  $('micBtn').onclick=()=> setMic(!(localStream?.getAudioTracks()[0]?.enabled));
  $('camBtn').onclick=()=> setCam(!(localStream?.getVideoTracks()[0]?.enabled));
  $('musicMode').onchange=async e=>{
    musicEnabled=e.target.checked;
    const newStream=await getMedia();
    if(currentCall){
      const senders=currentCall.peerConnection.getSenders();
      const nA=newStream.getAudioTracks()[0], nV=newStream.getVideoTracks()[0];
      const sA=senders.find(s=>s.track?.kind==='audio'), sV=senders.find(s=>s.track?.kind==='video');
      if(sA&&nA) sA.replaceTrack(nA); if(sV&&nV) sV.replaceTrack(nV);
    }
  };
  $('sidetone').onchange=e=>toggleSidetone(e.target.checked);

  const status = await checkPermissions();
  if(status==='granted'){
    try{ await getMedia(); $('permBanner').style.display='none'; setMic(true); setCam(true); await initPeerFlow(); }
    catch{ $('permBanner').style.display='block'; }
  }else{
    $('permBanner').style.display='block';
  }
})();
</script>
</body>
</html>
