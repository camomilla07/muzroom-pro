<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Muzroom Pro — Комната</title>
  <link rel="icon" href="/favicon.ico">
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <style>
    :root{
      --bg:#f2f4f8; --paper:#fff; --ink:#1f2430; --muted:#677083;
      --accent:#2e3543; --accent-weak:#e6eaf2; --radius:18px;
      --shadow:0 18px 40px rgba(16,20,32,.06);
      --ring:0 0 0 6px rgba(46,53,67,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    a{color:inherit;text-decoration:none}
    header,main,footer{max-width:1080px;margin:0 auto;padding:14px}
    header{display:flex;align-items:center;gap:12px}
    .logo{width:34px;height:34px;border-radius:999px;background:conic-gradient(from 210deg,#2e3543,#4a5469,#2e3543);display:grid;place-items:center;color:#fff;font-weight:700}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}

    .panel{background:var(--paper);border:1px solid var(--accent-weak);border-radius:18px;box-shadow:var(--shadow);padding:16px}
    .top{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:6px 0 14px}
    @media(max-width:900px){.top{grid-template-columns:1fr}}
    .top-title{color:var(--muted);margin-bottom:8px;font-weight:600}
    .code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f0f3fa;border:1px dashed #cdd5e6;border-radius:14px;padding:12px 14px;min-height:48px;display:flex;align-items:center;overflow-x:auto}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    .btn{appearance:none;border:0;border-radius:14px;padding:12px 18px;font-weight:700;cursor:pointer;transition:.2s}
    .btn:focus-visible{outline:none;box-shadow:var(--ring)}
    .btn-main{background:var(--accent);color:#fff}
    .btn-ghost{background:#fff;border:1px solid var(--accent-weak)}
    .btn-main:hover,.btn-ghost:hover{transform:translateY(-1px)}
    .btn-xs{padding:8px 12px;border-radius:10px;font-weight:600}
    .icon{width:18px;height:18px;vertical-align:-3px}

    .grid{display:grid;grid-template-columns:2fr 1fr;gap:20px}
    @media(max-width:1000px){.grid{grid-template-columns:1fr}}
    video,.audio{width:100%;background:#0b0f1a;border-radius:14px}
    .muted{color:var(--muted)}
    .switch-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}

    .hidden{display:none !important}

    /* Плейлист */
    .table{display:grid;gap:10px}
    .tr{display:grid;grid-template-columns:1fr 120px 130px 1fr;gap:12px;align-items:center;background:#f9fbff;border:1px solid #e6ecf7;border-radius:12px;padding:8px 12px}
    @media(max-width:780px){.tr{grid-template-columns:1fr 100px 120px 1fr}}
    .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .time{font-variant-numeric:tabular-nums;color:var(--muted);text-align:center}
    .gain{display:flex;align-items:center;gap:8px}
    .gain input[type="range"]{width:100%}
    .progress{height:6px;border-radius:999px;background:#eaeef7;overflow:hidden}
    .bar{height:100%;width:0%;background:#2e3543;transition:width .1s linear}
    .controls{display:flex;gap:8px}
  </style>
</head>
<body>
<header>
  <a href="/" class="brand"><span class="logo">М</span> Muzroom Pro</a>
</header>

<main>
  <!-- верхняя полоса -->
  <section class="top">
    <article class="panel" id="shareBlock">
      <div class="top-title">ссылка для ученика</div>
      <div id="shareCode" class="code">Пока нет ссылки</div>
      <div class="row">
        <button id="copyBtn" class="btn btn-ghost" disabled>Скопировать ссылку</button>
      </div>
    </article>

    <article class="panel">
      <div class="top-title" id="hint">разрешите доступ к микрофону/камере</div>
      <div class="row">
        <button id="askBtn" class="btn btn-main">Разрешить</button>
      </div>

      <div class="top-title" style="margin-top:16px">загрузить свои аудио файлы</div>
      <div class="row" style="align-items:center">
        <input id="fileInput" type="file" multiple accept="audio/*" style="padding:10px 12px;border-radius:12px;border:1px dashed #cdd5e6;background:#f8fbff">
        <button id="clearList" class="btn btn-ghost btn-xs">Очистить плейлист</button>
      </div>
    </article>
  </section>

  <!-- видео -->
  <section class="grid">
    <article class="panel">
      <video id="remoteVideo" autoplay playsinline></video>
      <div id="remoteState" class="muted" style="margin-top:8px">ожидание ученика…</div>
    </article>
    <article class="panel">
      <video id="localVideo" autoplay playsinline muted></video>
      <div class="switch-row">
        <button id="micBtn" class="btn btn-main">микрофон: вкл</button>
        <button id="camBtn" class="btn btn-ghost">камера: вкл</button>
      </div>
      <div class="switch-row">
        <label><input id="musicMode" type="checkbox" checked> музыкальный режим</label>
        <label><input id="sidetone" type="checkbox"> слышать себя (в наушниках)</label>
      </div>
      <audio id="monitor" class="audio hidden" controls></audio>
    </article>
  </section>

  <!-- плейлист -->
  <section class="panel" style="margin-top:14px">
    <div class="top-title">плейлист урока</div>
    <div id="table" class="table"></div>
  </section>
</main>

<footer class="panel" style="margin:16px auto;display:flex;justify-content:space-between;gap:8px">
  <div class="muted">muzroom pro – онлайн платформа для музыкальных уроков</div>
  <div class="muted">2025 muzroom pro – <a href="/privacy.html">Политика конфиденциальности</a></div>
</footer>

<script>
/* ===== Состояние ===== */
const $ = id => document.getElementById(id);
const qp = new URLSearchParams(location.search);
const isHost = qp.has('host');
const joinId = qp.get('join') || null;

let localStream=null, remoteStream=null, peer=null, currentCall=null;
let musicEnabled=true, monitorStarted=false;

// Web Audio для микширования
let audioCtx=null, mixDest=null, micSource=null;
let usingMixedTrack=false;

// Плейлист (in-memory)
const playlist = []; // [{name, buffer, duration}]
let playingIndex = -1;
let fileSource = null;        // AudioBufferSourceNode
let fileGainNode = null;      // GainNode
let progRAF = 0;

// SVG-иконки
const ICON_PLAY = '<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
const ICON_STOP = '<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>';

/* ===== RTC/Peer конфиг ===== */
const rtcConfig = {
  iceServers: [
    { urls: [
      'stun:stun.l.google.com:19302',
      'stun:stun1.l.google.com:19302',
      'stun:stun2.l.google.com:19302',
      'stun:stun.stunprotocol.org:3478',
      'stun:stun.nextcloud.com:443'
    ]}
    // Для «железобетона» добавьте платный TURN и впишите сюда:
    // ,{ urls:'turn:YOUR_TURN_HOST:3478', username:'USER', credential:'PASS' }
  ]
};
function newPeer() {
  try{ peer?.destroy?.(); }catch(_){}
  return new Peer(undefined, { config: rtcConfig, debug: 1 });
}

/* ===== Медиа ===== */
function getConstraints(){
  return {
    audio:{
      echoCancellation: !musicEnabled,
      noiseSuppression: !musicEnabled,
      autoGainControl: !musicEnabled,
      channelCount:1, sampleRate:48000
    },
    video:true
  };
}
async function getMedia(){
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  localStream = await navigator.mediaDevices.getUserMedia(getConstraints());
  const v=$('localVideo'); v.srcObject=localStream; v.muted=true; v.setAttribute('playsinline',''); try{await v.play();}catch(_){}
  // собрать аудиограф
  ensureGraph();
  // микрофон -> mix
  if(micSource) try{ micSource.disconnect(); }catch(_){}
  micSource = audioCtx.createMediaStreamSource(localStream);
  micSource.connect(mixDest);
  maybeUseMixedOutgoing();
  return localStream;
}

/* ===== Слышать себя ===== */
function toggleSidetone(on){
  const a=$('monitor');
  if(on){
    if(!monitorStarted){
      a.classList.remove('hidden'); a.srcObject=localStream; a.muted=false; a.play().catch(()=>{});
      monitorStarted=true;
    }
  }else{
    a.pause(); a.srcObject=null; a.classList.add('hidden'); monitorStarted=false;
  }
}

/* ===== Кнопки мик/кам ===== */
function setMic(on){
  localStream?.getAudioTracks().forEach(t=>t.enabled=on);
  $('micBtn').textContent = `микрофон: ${on?'вкл':'выкл'}`;
}
function setCam(on){
  localStream?.getVideoTracks().forEach(t=>t.enabled=on);
  $('camBtn').textContent = `камера: ${on?'вкл':'выкл'}`;
}

/* ===== Ссылка для ученика (только у учителя) ===== */
function showShare(id){
  const link = `${location.origin}/room.html?join=${encodeURIComponent(id)}`;
  $('shareCode').textContent = link;
  const btn=$('copyBtn'); btn.disabled=false;
  btn.onclick = async ()=>{
    try{ await navigator.clipboard.writeText(link); btn.textContent='Скопировано ✓'; setTimeout(()=>btn.textContent='Скопировать ссылку',1500); }
    catch{
      const r=document.createRange(); r.selectNodeContents($('shareCode'));
      const s=window.getSelection(); s.removeAllRanges(); s.addRange(r);
    }
  };
}

/* ===== PeerJS ===== */
function bindHandlersAsHost(){
  peer.on('call', call=>{
    currentCall=call; call.answer(localStream);
    bindStreamHandlers(call); maybeUseMixedOutgoing();
  });
}
function connectAsStudent(code){
  $('hint').textContent='Идёт звонок преподавателю…';
  const call=peer.call(code, localStream);
  currentCall=call; bindStreamHandlers(call); maybeUseMixedOutgoing();
}
function bindStreamHandlers(call){
  call.on('stream', rs=>{ remoteStream=rs; $('remoteVideo').srcObject=rs; $('remoteState').textContent='Соединение установлено'; });
  call.on('close', ()=>{ $('remoteState').textContent='Связь закончена'; });
  call.on('error', e=>{ console.error(e); $('remoteState').textContent='Ошибка соединения. Обновите страницу.'; });
}
function startHosting(){
  $('hint').textContent='Генерируем ссылку…';
  peer = newPeer();
  peer.on('open', id=>{ showShare(id); bindHandlersAsHost(); $('hint').textContent='Ссылка готова — отправьте ученику.'; });
  peer.on('error', e=>{ console.error(e); $('hint').textContent='Не удалось подключиться к сигналингу. Попробуйте ещё раз.'; });
}
function initPeerFlow(){
  peer = newPeer();
  if(joinId){ peer.on('open', ()=>connectAsStudent(joinId)); }
  else location.href='/';
  peer.on('error', e=>{ console.error(e); $('hint').textContent='Проблема с сигналингом. Обновите страницу.'; });
}

/* ===== Граф микширования ===== */
function ensureGraph(){
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  if(!mixDest)  mixDest  = audioCtx.createMediaStreamDestination();
  if(!fileGainNode){ fileGainNode = audioCtx.createGain(); fileGainNode.gain.value = 0.9; }
}
function maybeUseMixedOutgoing(){
  if(!mixDest || !currentCall) return;
  const track = mixDest.stream.getAudioTracks()[0]; if(!track) return;
  const sender = currentCall.peerConnection.getSenders().find(s=>s.track && s.track.kind==='audio');
  if(sender){ sender.replaceTrack(track); usingMixedTrack=true; }
}

/* ===== Плейлист ===== */
function renderTable(){
  const wrap=$('table'); wrap.innerHTML='';
  if(!playlist.length){ wrap.innerHTML='<div class="muted">плейлист пуст</div>'; return; }

  playlist.forEach((it,idx)=>{
    const row=document.createElement('div'); row.className='tr';

    const name=document.createElement('div'); name.className='name'; name.textContent=it.name;

    const time=document.createElement('div'); time.className='time'; time.id=`time-${idx}`; time.textContent=fmt(it.duration);

    const ctr=document.createElement('div'); ctr.className='controls';
    const play=document.createElement('button'); play.className='btn btn-main btn-xs';
    play.innerHTML = (playingIndex===idx? ICON_STOP+' Стоп' : ICON_PLAY+' Играть');
    play.onclick=()=>{ if(playingIndex===idx) stopPlayback(); else playIndex(idx); };

    const del=document.createElement('button'); del.className='btn btn-ghost btn-xs'; del.textContent='Удалить';
    del.onclick=()=>{ if(playingIndex===idx) stopPlayback(); playlist.splice(idx,1); renderTable(); };

    ctr.append(play, del);

    const right=document.createElement('div'); right.className='gain';
    const rng=document.createElement('input'); rng.type='range'; rng.min='0'; rng.max='1'; rng.step='0.01'; rng.value=fileGainNode?fileGainNode.gain.value:0.9;
    rng.oninput=(e)=>{ ensureGraph(); fileGainNode.gain.value=parseFloat(e.target.value); };
    right.append('громк.:', rng);

    // прогресс
    const progWrap=document.createElement('div'); progWrap.className='progress';
    const bar=document.createElement('div'); bar.className='bar'; bar.id=`bar-${idx}`;
    progWrap.append(bar);

    row.append(name, time, ctr, right);
    wrap.append(row, progWrap);
  });
}

function cancelRAF(){ if(progRAF) cancelAnimationFrame(progRAF); progRAF=0; }
function stopPlayback(){
  cancelRAF();
  if(fileSource){ try{fileSource.stop(0);}catch(_){ } try{fileSource.disconnect();}catch(_){} fileSource=null; }
  playingIndex=-1; renderTable();
}
function playIndex(idx){
  if(!playlist[idx]) return;
  ensureGraph();
  stopPlayback();
  const buf=playlist[idx].buffer;
  fileSource = audioCtx.createBufferSource();
  fileSource.buffer = buf;
  fileSource.connect(fileGainNode);
  fileGainNode.connect(mixDest);
  fileGainNode.connect(audioCtx.destination); // локальный монитор
  fileSource.start();

  const started = audioCtx.currentTime;
  const idTime = `time-${idx}`;
  const idBar  = `bar-${idx}`;
  playingIndex = idx; renderTable();

  const tick = ()=>{
    if(playingIndex!==idx) return;
    const t = Math.min(buf.duration, audioCtx.currentTime - started);
    const left = buf.duration - t;
    const timeEl = document.getElementById(idTime);
    const barEl  = document.getElementById(idBar);
    if(timeEl) timeEl.textContent = fmt(left);
    if(barEl)  barEl.style.width = `${(t / buf.duration) * 100}%`;
    progRAF = requestAnimationFrame(tick);
  };
  tick();

  fileSource.onended = ()=>{ stopPlayback(); };
  maybeUseMixedOutgoing();
}

/* ===== Файлы: загрузка ===== */
$('fileInput').addEventListener('change', async (e)=>{
  const files = Array.from(e.target.files||[]);
  if(!files.length) return;
  ensureGraph();
  for(const f of files){
    try{
      const arr = await f.arrayBuffer();
      const buf = await audioCtx.decodeAudioData(arr);
      playlist.push({name:f.name.replace(/\.(\w+)$/,''), buffer:buf, duration:buf.duration});
    }catch(err){ console.error('decode error', err); }
  }
  $('hint').textContent='Треки добавлены.';
  renderTable();
});
$('clearList').onclick=()=>{ stopPlayback(); playlist.length=0; renderTable(); };

/* ===== Ask разрешения (моб/десктоп) ===== */
function bindAskButtonOnce(){
  const askBtn=$('askBtn'); if(!askBtn) return;
  const handler=async ev=>{
    ev.preventDefault(); askBtn.disabled=true;
    try{
      await getMedia();
      $('hint').textContent='Доступ разрешён. Можно начинать.';
      setMic(true); setCam(true);
      if(isHost) startHosting(); else initPeerFlow();
    }catch(e){ console.error(e); $('hint').textContent='Не удалось получить доступ. Проверьте настройки сайта/браузера.'; }
    finally{ askBtn.disabled=false; }
  };
  ['click','touchend','pointerup'].forEach(t=>askBtn.addEventListener(t,handler,{passive:false}));
}

/* ===== Инициализация ===== */
(async function init(){
  if(!isHost){ $('shareBlock').classList.add('hidden'); } // скрываем ссылку у ученика

  $('micBtn').onclick=()=>setMic(!(localStream?.getAudioTracks()[0]?.enabled));
  $('camBtn').onclick=()=>setCam(!(localStream?.getVideoTracks()[0]?.enabled));
  $('musicMode').onchange=async e=>{ musicEnabled=e.target.checked; await getMedia(); };
  $('sidetone').onchange=e=>toggleSidetone(e.target.checked);

  bindAskButtonOnce();
  renderTable();

  // авто-старт, если права уже были выданы
  if(navigator.permissions){
    try{
      const mic=await navigator.permissions.query({name:'microphone'});
      const cam=await navigator.permissions.query({name:'camera'});
      if(mic.state==='granted' && cam.state==='granted'){
        await getMedia(); setMic(true); setCam(true);
        if(isHost) startHosting(); else initPeerFlow();
        $('hint').textContent='Доступ уже разрешён.';
      }
    }catch(_){}
  }
})();
</script>
</body>
</html>
