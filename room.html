<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Muzroom Pro ‚Äî –ö–æ–º–Ω–∞—Ç–∞</title>
  <link rel="icon" href="/favicon.ico">

  <!-- PeerJS –¥–ª—è –∑–≤–æ–Ω–∫–∞ -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <style>
    :root{
      --bg:#f7f8fb; --paper:#fff; --ink:#1f2430; --muted:#5b657a;
      --accent:#2e3543; --accent-weak:#e7eaf2; --ring:0 0 0 4px rgba(46,53,67,.15);
      --shadow:0 12px 28px rgba(16,20,32,.08); --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    header,footer{max-width:1100px;margin:0 auto;padding:16px 14px}
    header a{color:var(--ink);text-decoration:none;font-weight:700;display:flex;align-items:center;gap:10px}
    .logo{width:32px;height:32px;border-radius:999px;background:conic-gradient(from 210deg,#2e3543,#4a5469,#2e3543);display:grid;place-items:center;color:#fff}
    main{max-width:1100px;margin:0 auto;padding:12px 14px 26px;display:grid;gap:12px}
    .panel{background:var(--paper);border:1px solid var(--accent-weak);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f0f3fa;border:1px dashed #cdd5e6;border-radius:12px;padding:12px}
    .btn{appearance:none;border:none;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer;transition:.25s;outline:none}
    .btn:focus-visible{box-shadow:var(--ring)}
    .btn-main{background:var(--accent);color:#fff}
    .btn-main:hover{box-shadow:0 10px 18px rgba(46,53,67,.18);background:#262c38}
    .btn-ghost{background:#fff;border:1px solid var(--accent-weak);color:var(--ink)}
    .btn-ghost[disabled]{opacity:.5;pointer-events:none}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    video,.audio{width:100%;background:#0b0f1a;border-radius:12px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .input-like{width:100%;border:2px dashed #cdd5e6;background:#f5f8ff;border-radius:12px;padding:14px 16px;color:#465167}
    .controls{display:flex;align-items:center;gap:8px}
    .icon{width:18px;height:18px;vertical-align:-3px}
    .track{display:flex;align-items:center;gap:10px}
    .bar{flex:1;height:6px;background:#e9eef7;border-radius:999px;position:relative;overflow:hidden}
    .bar>span{position:absolute;left:0;top:0;bottom:0;width:0;background:#2e3543}
    .vol{width:140px}
  </style>
</head>
<body>
  <header>
    <a href="/"><span class="logo">–ú</span> Muzroom Pro</a>
  </header>

  <main>

    <!-- –°—Å—ã–ª–∫–∞ –¥–ª—è —É—á–µ–Ω–∏–∫–∞ -->
    <section class="panel">
      <div class="muted small" id="roleBadge">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶</div>
      <div class="muted" id="hint">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É/–∫–∞–º–µ—Ä–µ.</div>

      <div class="row" style="margin-top:8px">
        <div class="input-like" id="shareCode">–ü–æ–∫–∞ –Ω–µ—Ç —Å—Å—ã–ª–∫–∏</div>
        <button class="btn btn-ghost" id="copyBtn" disabled>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
      </div>
    </section>

    <!-- –†–∞–∑—Ä–µ—à–µ–Ω–∏—è -->
    <section class="panel" id="permBanner" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div class="muted">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞/–±—Ä–∞—É–∑–µ—Ä–∞.</div>
        <button class="btn btn-main" id="askBtn">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
      </div>
      <div class="small muted" id="iosHint" style="margin-top:6px;display:none">
        –ù–∞ iPhone: –∞–¥—Ä–µ—Å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Üí ¬´aA¬ª ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞ ‚Üí –ú–∏–∫—Ä–æ—Ñ–æ–Ω/–ö–∞–º–µ—Ä–∞ ‚Üí ¬´–†–∞–∑—Ä–µ—à–∏—Ç—å¬ª, –∑–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.
      </div>
    </section>

    <!-- –í–∏–¥–µ–æ—Å–µ—Ç–∫–∞ -->
    <section class="grid">
      <div class="panel">
        <video id="remoteVideo" autoplay playsinline></video>
        <div class="muted small" id="remoteState" style="margin-top:6px">–û–∂–∏–¥–∞–Ω–∏–µ —É—á–µ–Ω–∏–∫–∞‚Ä¶</div>
      </div>

      <div class="panel">
        <video id="localVideo" autoplay playsinline muted></video>

        <div class="row" style="margin-top:10px">
          <button class="btn btn-main" id="micBtn">üéôÔ∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω: –í–∫–ª</button>
          <button class="btn btn-ghost" id="camBtn">üì∑ –ö–∞–º–µ—Ä–∞: –í–∫–ª</button>
        </div>

        <div class="row" style="margin-top:8px">
          <label class="muted"><input id="musicMode" type="checkbox" checked> –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º (–±–µ–∑ —à—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏—è)</label>
          <label class="muted"><input id="sidetone" type="checkbox"> –°–ª—ã—à–∞—Ç—å —Å–µ–±—è (–≤ –Ω–∞—É—à–Ω–∏–∫–∞—Ö)</label>
        </div>
      </div>
    </section>

    <!-- –ê—É–¥–∏–æ—Ñ–∞–π–ª—ã -->
    <section class="panel">
      <div class="muted" style="margin-bottom:8px">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–∏ –∞—É–¥–∏–æ —Ñ–∞–π–ª—ã</div>
      <div class="row">
        <!-- –í–ê–ñ–ù–û: —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π accept –¥–ª—è iOS/Android -->
        <input id="filePicker" type="file" multiple
               accept="audio/mpeg,audio/mp3,audio/mp4,audio/x-m4a,audio/aac,audio/wav,audio/ogg,audio/webm,audio/*,video/quicktime"/>
        <button class="btn btn-ghost" id="clearList">–û—á–∏—Å—Ç–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç</button>
      </div>

      <!-- –ø–ª–µ–π–ª–∏—Å—Ç -->
      <div id="playlist" style="margin-top:10px;display:grid;gap:10px"></div>

      <!-- —Å–∫—Ä—ã—Ç—ã–π —Ç–µ–≥ –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫–∞ -->
      <audio id="hiddenPlayer" crossorigin="anonymous"></audio>
    </section>

    <section class="panel">
      <div class="muted small">
        –°–æ–≤–µ—Ç: –µ—Å–ª–∏ —Å–≤—è–∑—å —Å–ª–∞–±–∞—è, –≤—ã–∫–ª—é—á–∏—Ç–µ –∫–∞–º–µ—Ä—É ‚Äî –∑–≤—É–∫ —Å—Ç–∞–Ω–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ. –ù–∞ iPhone –∞—É–¥–∏–æ –Ω–∞—á–Ω—ë—Ç –∏–≥—Ä–∞—Ç—å –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞.
      </div>
    </section>

  </main>

  <footer class="row" style="justify-content:space-between">
    <div class="muted small">Muzroom Pro ‚Äî –æ–Ω–ª–∞–π–Ω-–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö —É—Ä–æ–∫–æ–≤</div>
    <div class="muted small">¬© 2025 Muzroom Pro ¬∑ <a href="/privacy.html">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a></div>
  </footer>

<script>
/* ====== –£–¢–ò–õ–ò–¢–´ / –°–û–°–¢–û–Ø–ù–ò–ï ====== */
const $ = id => document.getElementById(id);
const qp = new URLSearchParams(location.search);
const isHost = qp.has('host');
const joinId = qp.get('join') || null;
const GEN = () => Math.random().toString(36).slice(2,8).toUpperCase();

let localStream=null, remoteStream=null, peer=null, currentCall=null;
let musicEnabled = true;
let monitorStarted = false;

// iOS –ø–æ–¥—Å–∫–∞–∑–∫–∞
const isIOS = /iP(ad|hone|od)/.test(navigator.userAgent) ||
  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
if(isIOS) $('iosHint').style.display='block';

/* ====== –ú–ï–î–ò–ê ====== */
function getConstraints(){
  return {
    audio:{
      echoCancellation: !musicEnabled,
      noiseSuppression: !musicEnabled,
      autoGainControl: !musicEnabled,
      channelCount: 1,
      sampleRate: 48000
    },
    video:true
  };
}

async function getMedia(){
  if(localStream){ localStream.getTracks().forEach(t=>t.stop()); }
  localStream = await navigator.mediaDevices.getUserMedia(getConstraints());
  $('localVideo').srcObject = localStream;
  return localStream;
}

function setMic(on){
  localStream?.getAudioTracks().forEach(t=>t.enabled = on);
  $('micBtn').textContent = `üéôÔ∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω: ${on?'–í–∫–ª':'–í—ã–∫–ª'}`;
}
function setCam(on){
  localStream?.getVideoTracks().forEach(t=>t.enabled = on);
  $('camBtn').textContent = `üì∑ –ö–∞–º–µ—Ä–∞: ${on?'–í–∫–ª':'–í—ã–∫–ª'}`;
}

function toggleSidetone(on){
  const audio = $('hiddenPlayer');
  if(on){
    if(!monitorStarted){
      audio.hidden = false;
      audio.srcObject = localStream;
      audio.muted = false;
      audio.play().catch(()=>{});
      monitorStarted = true;
    }
  }else{
    audio.pause(); audio.srcObject=null; monitorStarted=false;
  }
}

/* ====== PERMISSIONS (–∫–Ω–æ–ø–∫–∞ —Ç–æ—á–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç getUserMedia –Ω–∞ iOS/Android) ====== */
$('askBtn').addEventListener('click', async ()=>{
  try{
    await getMedia();
    $('permBanner').style.display='none';
    $('hint').textContent = '–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω. –ú–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å —É—Ä–æ–∫.';
    setMic(true); setCam(true);
    if(!peer) await initPeerFlow();            // —Å—Ç–∞—Ä—Ç –∑–≤–æ–Ω–∫–∞ –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞
  }catch(e){
    console.error(e);
    $('hint').textContent = '–î–æ—Å—Ç—É–ø –Ω–µ –ø–æ–ª—É—á–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞.';
  }
});

async function checkPermissions(){
  // –ù–∞ iOS API Permissions –Ω–µ—Ç ‚Äî —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
  if(!navigator.permissions){ $('permBanner').style.display='block'; return; }
  try{
    const m = await navigator.permissions.query({name:'microphone'});
    const c = await navigator.permissions.query({name:'camera'});
    if(m.state==='granted' && c.state==='granted'){
      await getMedia(); $('permBanner').style.display='none';
      if(!peer) await initPeerFlow();
    }else{
      $('permBanner').style.display='block';
    }
  }catch{
    $('permBanner').style.display='block';
  }
}

/* ====== PeerJS —Å –ø—É–±–ª–∏—á–Ω—ã–º TURN (—á—Ç–æ–±—ã ¬´–ø—Ä–æ–±–∏–≤–∞–ª–æ¬ª NAT –∏ –º–æ–±–∏–ª—å–Ω—ã–µ —Å–µ—Ç–∏) ====== */
function createPeer(withId){
  const cfg = {
    config: {
      iceServers: [
        {urls: 'stun:stun.l.google.com:19302'},
        // –ü—É–±–ª–∏—á–Ω—ã–π TURN OpenRelay (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π, –Ω–æ –¥–ª—è MVP –æ—Ç–ª–∏—á–Ω–æ)
        {urls: 'turn:openrelay.metered.ca:80', username:'openrelayproject', credential:'openrelayproject'},
        {urls: 'turn:openrelay.metered.ca:443', username:'openrelayproject', credential:'openrelayproject'},
        {urls: 'turn:openrelay.metered.ca:443?transport=tcp', username:'openrelayproject', credential:'openrelayproject'},
      ]
    }
  };
  return withId ? new Peer(withId, cfg) : new Peer(undefined, cfg);
}

async function initPeerFlow(){
  peer = createPeer();

  if(isHost){
    peer.on('open', () => {
      const code = GEN();               // —Å–≤–æ–π –∫—Ä–∞—Å–∏–≤—ã–π –∫–æ–¥
      peer.destroy();
      peer = createPeer(code);
      peer.on('open', ()=> showShare(code));
      bindHandlersAsHost();
    });
  }else if(joinId){
    peer.on('open', ()=> connectAsStudent(joinId));
  }else{
    location.href = '/';
  }
}

function showShare(code){
  const link = `${location.origin}/room.html?join=${encodeURIComponent(code)}`;
  $('shareCode').textContent = link;
  $('copyBtn').disabled = false;
  $('copyBtn').onclick = async ()=>{
    try{
      await navigator.clipboard.writeText(link);
      $('copyBtn').textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úì';
      setTimeout(()=>$('copyBtn').textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É',1500);
    }catch{
      const r=document.createRange(); r.selectNodeContents($('shareCode'));
      const s=window.getSelection(); s.removeAllRanges(); s.addRange(r);
    }
  };
  $('hint').textContent = '–û—Ç–ø—Ä–∞–≤—å—Ç–µ —É—á–µ–Ω–∏–∫—É —Å—Å—ã–ª–∫—É.';
}

function bindStreamHandlers(call){
  call.on('stream', rs=>{
    remoteStream = rs;
    $('remoteVideo').srcObject = rs;
    $('remoteState').textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
  });
  call.on('close', ()=> $('remoteState').textContent = '–°–≤—è–∑—å –∑–∞–∫–æ–Ω—á–µ–Ω–∞');
  call.on('error', e=> { console.error(e); $('remoteState').textContent='–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'; });
}

function bindHandlersAsHost(){
  peer.on('call', call=>{
    currentCall = call;
    call.answer(localStream);
    bindStreamHandlers(call);
  });
}

function connectAsStudent(code){
  $('shareCode').textContent = `–ö–æ–¥: ${code}`;
  $('copyBtn').disabled = true;
  $('hint').textContent = '–ó–≤–æ–Ω–∏–º –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—é‚Ä¶';
  const call = peer.call(code, localStream);
  currentCall = call; bindStreamHandlers(call);
}

<script>
/* ====== –ê—É–¥–∏–æ–ø–ª–µ–π–ª–∏—Å—Ç (–≤–∏–¥—è—Ç –∏ —Å–ª—ã—à–∞—Ç –æ–±–∞) ====== */
const picker = $('filePicker');
const playlist = $('playlist');
const hiddenPlayer = $('hiddenPlayer');

let fileTrack = null;        // –∞—É–¥–∏–æ—Ç—Ä–µ–∫, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É
let ctx = null, srcNode = null, outNode = null; // WebAudio
let splitter=null, merger=null, gL=null, gR=null, hp=null; // –¥–ª—è –∫–∞—Ä–∞–æ–∫–µ
let pitchSemis = 0;          // —à–∞–≥–∏ –≤ –ø–æ–ª—É—Ç–æ–Ω–∞—Ö (–º–æ–∂–µ—Ç –±—ã—Ç—å 0.5, -0.5 –∏ —Ç.–ø.)
let dragging = null;         // {bar, fill, player}

function isMobile() { return window.matchMedia('(max-width: 600px)').matches; }
function shortTitle(name){
  if(!isMobile()) return name;
  const base = name.split('/').pop().split('\\').pop();
  return (base.length > 4) ? (base.slice(0,4) + '‚Ä¶') : base;
}

function svgPlay(){return `<svg class="icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" fill="currentColor"/></svg>`}
function svgPause(){return `<svg class="icon" viewBox="0 0 24 24"><path d="M6 5h4v14H6zM14 5h4v14h-4z" fill="currentColor"/></svg>`}

function renderItem(name, url){
  const row = document.createElement('div');
  row.className='track';

  // play/pause
  const pp = document.createElement('button');
  pp.className='btn btn-ghost';
  pp.innerHTML = svgPlay();

  const title = document.createElement('div');
  title.textContent = shortTitle(name);
  title.style.minWidth='64px';

  const bar = document.createElement('div'); bar.className='bar';
  const fill = document.createElement('span'); bar.appendChild(fill);

  const vol = document.createElement('input'); vol.type='range';
  vol.min=0; vol.max=1; vol.step=0.01; vol.value=1; vol.className='vol';

  row.append(pp,title,bar,vol);
  playlist.appendChild(row);

  const player = hiddenPlayer;

  // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
  function sync(){
    if (player.duration>0) fill.style.width = `${(player.currentTime/player.duration)*100}%`;
    if (!player.paused) requestAnimationFrame(sync);
  }

  async function ensureWebAudioGraph(){
    ctx = ctx || new (window.AudioContext || window.webkitAudioContext)();
    if (!srcNode || srcNode.mediaElement !== player) {
      // –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ü–µ–ø–æ—á–∫—É –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ <audio>
      if (srcNode) srcNode.disconnect();
      srcNode = ctx.createMediaElementSource(player);
      outNode = ctx.createMediaStreamDestination();
      srcNode.connect(ctx.destination);   // —á—Ç–æ–±—ã —Å–ª—ã—à–∞–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ
      srcNode.connect(outNode);           // —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É
    }
    // –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫ ‚Äî –¥–æ–±–∞–≤–∏–º/–∑–∞–º–µ–Ω–∏–º –¥–æ—Ä–æ–∂–∫—É
    if (currentCall) {
      if (!fileTrack) {
        fileTrack = outNode.stream.getAudioTracks()[0] || null;
        if (fileTrack) currentCall.peerConnection.addTrack(fileTrack, outNode.stream);
      }
    }
  }

  // –ø—Ä–æ—Å—Ç–æ–π pitch: –º–µ–Ω—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å = –º–µ–Ω—è–µ—Ç—Å—è –∏ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
  function applyPitch(){
    const rate = Math.pow(2, pitchSemis/12);
    player.playbackRate = rate;
  }

  // –ø–µ—Ä–µ–º–æ—Ç–∫–∞ –ø–æ –∫–ª–∏–∫—É/–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—é
  function setTimeByClientX(clientX){
    const rect = bar.getBoundingClientRect();
    const x = Math.min(Math.max(clientX - rect.left, 0), rect.width);
    const ratio = rect.width ? (x / rect.width) : 0;
    if (player.duration>0) player.currentTime = ratio * player.duration;
  }
  bar.addEventListener('pointerdown', (e)=>{
    dragging = {bar, fill, player};
    setTimeByClientX(e.clientX);
  });
  window.addEventListener('pointermove', (e)=>{
    if (dragging && dragging.player===player) setTimeByClientX(e.clientX);
  });
  window.addEventListener('pointerup', ()=>{
    if (dragging && dragging.player===player) dragging=null;
  });

  pp.onclick = async ()=>{
    // –µ—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –¥—Ä—É–≥–æ–π —Ç—Ä–µ–∫ ‚Äî –∑–∞–¥–∞—ë–º –Ω–æ–≤—ã–π src
    if (player.src !== url) {
      player.src = url;
      player.currentTime = 0;
    }
    applyPitch();
    player.volume = vol.value;

    if (player.paused) {
      await ensureWebAudioGraph();
      await player.play().catch(()=>{});
      pp.innerHTML = svgPause();
      requestAnimationFrame(sync);
    } else {
      player.pause();
      pp.innerHTML = svgPlay();
    }
  };

  vol.oninput = ()=> player.volume = vol.value;

  // –∫–æ–≥–¥–∞ —Ç—Ä–µ–∫ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è ‚Äî –≤–µ—Ä–Ω—É—Ç—å –∫–Ω–æ–ø–∫—É –≤ Play
  player.addEventListener('ended', ()=>{
    if (player.src === url) pp.innerHTML = svgPlay();
  });
}

// –∫–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏
$('clearList').onclick = ()=>{
  playlist.innerHTML='';
  hiddenPlayer.pause(); hiddenPlayer.removeAttribute('src');
  if (picker.value) picker.value = '';
};

// –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ (–º–æ–±–∏–ª–∫–∞: blob-URL)
picker.addEventListener('change', ()=>{
  playlist.innerHTML='';
  Array.from(picker.files||[]).forEach(f=>{
    const url = URL.createObjectURL(f);
    renderItem(f.name, url);
  });
});

/* === –ö–∞—Ä–∞–æ–∫–µ (L‚àíR), –≤–∫–ª—é—á–∞–µ—Ç—Å—è/–≤—ã–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ–≤–µ—Ä—Ö WebAudio === */
function applyKaraoke(on){
  if (!ctx || !srcNode) return; // –µ—â—ë –Ω–µ –∏–≥—Ä–∞–µ–º

  // —Ä–∞–∑—Ä—ã–≤–∞–µ–º –ø—Ä–æ—à–ª—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
  try { srcNode.disconnect(); } catch(_){}
  if (splitter){ try{ splitter.disconnect(); }catch(_){} }
  if (gL){ try{ gL.disconnect(); gR.disconnect(); merger.disconnect(); }catch(_){}
    splitter = merger = gL = gR = hp = null;
  }

  if (on){
    splitter = ctx.createChannelSplitter(2);
    gL = ctx.createGain(); gR = ctx.createGain();
    gL.gain.value = 1; gR.gain.value = -1;      // –∏–Ω–≤–µ—Ä—Ç –ø—Ä–∞–≤–æ–≥–æ
    merger = ctx.createChannelMerger(2);

    srcNode.connect(splitter);
    splitter.connect(gL, 0); splitter.connect(gR, 1);
    // —Å–≤–µ–¥—ë–º –≤ –æ–¥–∏–Ω –∫–∞–Ω–∞–ª (–∏–ª–∏ –≤ –æ–±–∞ –æ–¥–∏–Ω–∞–∫–æ–≤–æ)
    const sum = ctx.createGain();               // L-R -> mono
    gL.connect(sum); gR.connect(sum);

    // —á—É—Ç—å –ø–æ–¥—Ä–µ–∂–µ–º –Ω–∏–∑, —á—Ç–æ–±—ã –±–∞—Å –Ω–µ ¬´–ø–ª–∞–≤–∞–ª¬ª
    hp = ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value = 120;
    sum.connect(hp);

    // –≤ —É—à–∏
    hp.connect(ctx.destination);
    // –≤ WebRTC
    outNode = outNode || ctx.createMediaStreamDestination();
    hp.connect(outNode);

  } else {
    // –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º: –Ω–∞–ø—Ä—è–º—É—é
    outNode = outNode || ctx.createMediaStreamDestination();
    srcNode.connect(ctx.destination);
    srcNode.connect(outNode);
  }

  // –æ–±–Ω–æ–≤–∏–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—É—é –¥–æ—Ä–æ–∂–∫—É
  if (currentCall && outNode){
    const newTrack = outNode.stream.getAudioTracks()[0];
    if (fileTrack && newTrack && newTrack !== fileTrack){
      const pc = currentCall.peerConnection;
      const snd = pc.getSenders().find(s=>s.track === fileTrack);
      if (snd) try{ snd.replaceTrack(newTrack); }catch(_){}
      fileTrack = newTrack;
    } else if (!fileTrack && newTrack){
      currentCall.peerConnection.addTrack(newTrack, outNode.stream);
      fileTrack = newTrack;
    }
  }
}

/* === –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã—Å–æ—Ç–æ–π –∏ –∫–∞—Ä–∞–æ–∫–µ === */
function addGlobalAudioControls(){
  // –ø–∞–Ω–µ–ª—å —Ä–∏—Å—É–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ–¥ –ø–ª–µ–π–ª–∏—Å—Ç–æ–º
  if (document.getElementById('audioControls')) return;
  const wrap = document.createElement('div');
  wrap.id='audioControls';
  wrap.className='row';
  wrap.style.marginTop='12px';

  const lbl = document.createElement('div');
  lbl.className='muted small';
  lbl.textContent='–í—ã—Å–æ—Ç–∞:';

  const minus = document.createElement('button');
  minus.className='btn btn-ghost'; minus.textContent='‚ô≠ ‚àí0.5';

  const plus = document.createElement('button');
  plus.className='btn btn-ghost'; plus.textContent='‚ôØ +0.5';

  const reset = document.createElement('button');
  reset.className='btn btn-ghost'; reset.textContent='—Å–±—Ä–æ—Å';

  const val = document.createElement('div');
  val.className='muted small'; val.style.minWidth='70px'; val.textContent='0';

  const karo = document.createElement('button');
  karo.className='btn btn-ghost'; karo.textContent='–ö–∞—Ä–∞–æ–∫–µ (–º–∏–Ω—É—Å –≤–æ–∫–∞–ª): –≤—ã–∫–ª';
  let karaokeOn = false;

  minus.onclick = ()=> { pitchSemis -= 0.5; val.textContent=pitchSemis.toString(); hiddenPlayer.playbackRate = Math.pow(2, pitchSemis/12); };
  plus.onclick  = ()=> { pitchSemis += 0.5; val.textContent=pitchSemis.toString(); hiddenPlayer.playbackRate = Math.pow(2, pitchSemis/12); };
  reset.onclick = ()=> { pitchSemis = 0;   val.textContent='0'; hiddenPlayer.playbackRate = 1; };

  karo.onclick = ()=>{
    karaokeOn = !karaokeOn;
    karo.textContent = '–ö–∞—Ä–∞–æ–∫–µ (–º–∏–Ω—É—Å –≤–æ–∫–∞–ª): ' + (karaokeOn?'–≤–∫–ª':'–≤—ã–∫–ª');
    applyKaraoke(karaokeOn);
  };

  wrap.append(lbl,minus,plus,reset,val,karo);
  playlist.after(wrap);
}
addGlobalAudioControls();
</script>


/* ====== –ò–ù–ò–¢ UI –ò –ó–í–û–ù–ö–ê ====== */
$('roleBadge').textContent = isHost ? '–í—ã ‚Äî –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å' : '–í—ã ‚Äî —É—á–µ–Ω–∏–∫';
$('micBtn').onclick = ()=> setMic(!(localStream?.getAudioTracks()[0]?.enabled));
$('camBtn').onclick = ()=> setCam(!(localStream?.getVideoTracks()[0]?.enabled));
$('musicMode').onchange = async (e)=>{
  musicEnabled = e.target.checked;
  const newStream = await getMedia();
  if(currentCall){
    const senders = currentCall.peerConnection.getSenders();
    const nA = newStream.getAudioTracks()[0], nV = newStream.getVideoTracks()[0];
    const sA = senders.find(s=>s.track?.kind==='audio'), sV = senders.find(s=>s.track?.kind==='video');
    if(sA && nA) sA.replaceTrack(nA);
    if(sV && nV) sV.replaceTrack(nV);
  }
};
$('sidetone').onchange = e => toggleSidetone(e.target.checked);

// –ü—ã—Ç–∞–µ–º—Å—è —Ç–∏—Ö–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ—Å—Ç—É–ø (–≤ –¥–µ—Å–∫—Ç–æ–ø-–±—Ä–∞—É–∑–µ—Ä–∞—Ö), –Ω–∞ iOS —Å—Ä–∞–∑—É –ø–æ–∫–∞–∂–µ–º –∫–Ω–æ–ø–∫—É
checkPermissions();
</script>
</body>
</html>
