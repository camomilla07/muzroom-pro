<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Muzroom Pro ‚Äî –ö–æ–º–Ω–∞—Ç–∞</title>
<link rel="icon" href="/favicon.ico">
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
  :root{
    --bg:#f6f8fb; --paper:#fff; --ink:#1f2430; --muted:#5b657a;
    --accent:#2e3543; --accent-weak:#e7eaf2; --ring:0 0 0 4px rgba(46,53,67,.15);
    --shadow:0 12px 28px rgba(16,20,32,.08); --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg)}
  header,footer{max-width:1024px;margin:0 auto;padding:16px 14px}
  header a{color:var(--ink);text-decoration:none;font-weight:700;display:flex;align-items:center;gap:10px}
  .logo{width:32px;height:32px;border-radius:999px;background:conic-gradient(from 210deg,#2e3543,#4a5469,#2e3543);display:grid;place-items:center;color:#fff}
  main{max-width:1024px;margin:0 auto;padding:12px 14px 26px;display:grid;gap:12px}
  .panel{background:var(--paper);border:1px solid var(--accent-weak);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .col{display:grid;gap:10px}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:12px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
  .badge{display:inline-block;padding:3px 8px;border-radius:8px;background:#ecf0f8;color:#2e3543;font-size:12px;font-weight:600}
  .muted{color:var(--muted)}
  .code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f0f3fa;border:1px dashed #cdd5e6;border-radius:12px;padding:10px 12px;word-break:break-all}
  .btn{appearance:none;border:none;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer;transition:.25s;outline:none}
  .btn:focus-visible{box-shadow:var(--ring)}
  .btn-main{background:var(--accent);color:#fff}
  .btn-main:hover{box-shadow:0 10px 18px rgba(46,53,67,.18);background:#262c38}
  .btn-ghost{background:#fff;border:1px solid var(--accent-weak);color:var(--ink)}
  .btn-ghost:hover{border-color:#cfd6e6;box-shadow:0 8px 16px rgba(46,53,67,.08) inset,0 6px 14px rgba(46,53,67,.10)}
  video,.audio{width:100%;background:#0b0f1a;border-radius:12px}
  .pill{padding:10px 12px;border:1px dashed #cfd6e6;border-radius:12px;background:#f7f9ff}
  .pill .title{font-weight:700;margin-bottom:6px}
  /* –ø–ª–µ–π–ª–∏—Å—Ç */
  .track{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:8px;border:1px solid #ecf0f6;border-radius:12px}
  .iconbtn{width:40px;height:40px;border-radius:12px;border:1px solid #e3e7f2;background:#fff;display:grid;place-items:center;cursor:pointer}
  .iconbtn:active{transform:scale(.98)}
  .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%}
  .bar{appearance:none;width:100%;height:6px;border-radius:6px;background:#e8edf7;outline:none}
  .bar::-webkit-slider-thumb{appearance:none;width:14px;height:14px;border-radius:50%;background:#2e3543}
  .time{font-variant-numeric:tabular-nums;font-size:12px;color:#5b657a;padding:0 4px}
  @media(max-width:480px){ .name{max-width:12ch} } /* –Ω–∞ –º–æ–±–∏–ª–µ –∫–æ—Ä–æ—á–µ –∏–º–µ–Ω–∞ */
</style>
</head>
<body>
<header>
  <a href="/"><span class="logo">–ú</span> Muzroom Pro</a>
</header>

<main>
  <!-- –ü–∞–Ω–µ–ª—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è —Å–æ —Å—Å—ã–ª–∫–æ–π -->
  <section class="panel row" id="sharePanel" style="display:none;justify-content:space-between">
    <div class="pill" style="min-width:240px;flex:1">
      <div class="title">—Å—Å—ã–ª–∫–∞ –¥–ª—è —É—á–µ–Ω–∏–∫–∞</div>
      <div class="code" id="shareCode">–ü–æ–∫–∞ –Ω–µ—Ç —Å—Å—ã–ª–∫–∏</div>
    </div>
    <button class="btn btn-ghost" id="copyBtn" style="display:none">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
  </section>

  <!-- –ü–ª–∞—à–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π -->
  <section class="panel row" id="permPanel" style="display:none;justify-content:space-between">
    <div class="muted" id="permText">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É/–∫–∞–º–µ—Ä–µ.</div>
    <button class="btn btn-main" id="askBtn">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
  </section>

  <!-- –°–µ—Ç–∫–∞ –≤–∏–¥–µ–æ -->
  <section class="grid">
    <div class="panel">
      <video id="remoteVideo" autoplay playsinline></video>
      <div class="muted" id="remoteState" style="margin-top:6px">–û–∂–∏–¥–∞–Ω–∏–µ —É—á–µ–Ω–∏–∫–∞‚Ä¶</div>
    </div>
    <div class="panel col">
      <video id="localVideo" autoplay playsinline muted></video>
      <div class="row" style="margin-top:6px">
        <button class="btn btn-main" id="micBtn">üéôÔ∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω: –í–∫–ª</button>
        <button class="btn btn-ghost" id="camBtn">üì∑ –ö–∞–º–µ—Ä–∞: –í–∫–ª</button>
      </div>
      <label class="row"><input id="musicMode" type="checkbox" checked> –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º (–±–µ–∑ —à—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏—è)</label>
      <label class="row"><input id="sidetone" type="checkbox"> –°–ª—ã—à–∞—Ç—å —Å–µ–±—è (–≤ –Ω–∞—É—à–Ω–∏–∫–∞—Ö)</label>
      <audio id="monitor" class="audio" controls hidden></audio>
    </div>
  </section>

  <!-- –ê—É–¥–∏–æ—Ñ–∞–π–ª—ã -->
  <section class="panel col">
    <div class="pill">
      <div class="title">–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–∏ –∞—É–¥–∏–æ —Ñ–∞–π–ª—ã</div>
      <div class="row">
        <input type="file" id="fileInput" accept="audio/*" multiple>
        <button class="btn btn-ghost" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç</button>
      </div>
    </div>
    <div id="playlist" class="col"></div>
  </section>
</main>

<footer class="row" style="justify-content:space-between">
  <div class="muted">muzroom pro ‚Äî –æ–Ω–ª–∞–π–Ω-–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö —É—Ä–æ–∫–æ–≤</div>
  <div class="muted">2025 muzroom pro ¬∑ <a href="/privacy.html">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a></div>
</footer>

<!-- —Å–∫—Ä—ã—Ç—ã–π –ø–ª–µ–µ—Ä –¥–ª—è –º–∏–∫—à–µ—Ä–∞ -->
<audio id="hiddenPlayer" crossorigin="anonymous"></audio>

<script>
/* ------------------ –£–¢–ò–õ–ò–¢–´ ------------------ */
const $ = (id)=>document.getElementById(id);
const qp = new URLSearchParams(location.search);
const isHost = qp.has('host');
const joinId = qp.get('join') || null;
const GEN = ()=> Math.random().toString(36).slice(2,8).toUpperCase();

let localStream=null, remoteStream=null, peer=null, currentCall=null;
let musicEnabled=true, monitorStarted=false;

/* WebAudio –¥–ª—è –º–∏–∫—Å–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω+–ø–ª–µ–µ—Ä */
let audioCtx=null, micSource=null, micGain=null, musicSource=null, musicGain=null, mixDest=null, musicSender=null;

/* ------------------ –ú–ï–î–ò–ê ------------------ */
function getConstraints(){
  return {
    audio:{
      echoCancellation: !musicEnabled ? true : false,
      noiseSuppression: !musicEnabled ? true : false,
      autoGainControl: !musicEnabled ? true : false,
      channelCount:1,
      sampleRate:48000
    },
    video:true
  };
}

async function getMedia(){
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  localStream = await navigator.mediaDevices.getUserMedia(getConstraints());
  $('localVideo').srcObject = localStream;
  // —Å–æ–±—Ä–∞—Ç—å –º–∏–∫—à–µ—Ä (–ø–æ–∫–∞ –±–µ–∑ –º—É–∑—ã–∫–∏)
  rebuildAudioMixer($('hiddenPlayer'));
  return localStream;
}

/* ------------------ –°–ò–î–ï–¢–û–ù ------------------ */
function toggleSidetone(on){
  const audio = $('monitor');
  if(on){
    if(!monitorStarted){
      audio.hidden=false;
      audio.srcObject=localStream;
      audio.muted=false;
      audio.play().catch(()=>{});
      monitorStarted=true;
    }
  }else{
    audio.pause(); audio.srcObject=null; audio.hidden=true; monitorStarted=false;
  }
}

/* ------------------ –ú–ò–ö/–ö–ê–ú ------------------ */
function setMic(on){
  localStream?.getAudioTracks().forEach(t=>t.enabled=on); // –ª–æ–∫–∞–ª—å–Ω–æ–µ –ø—Ä–µ–≤—å—é
  if(micGain) micGain.gain.value = on ? 1 : 0;            // –≤ –º–∏–∫—à–µ—Ä–µ
  $('micBtn').textContent = `üéôÔ∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω: ${on?'–í–∫–ª':'–í—ã–∫–ª'}`;
}
function setCam(on){
  localStream?.getVideoTracks().forEach(t=>t.enabled=on);
  $('camBtn').textContent = `üì∑ –ö–∞–º–µ—Ä–∞: ${on?'–í–∫–ª':'–í—ã–∫–ª'}`;
}

/* ------------------ –ú–ò–ö–®–ï–† ------------------ */
function rebuildAudioMixer(playerEl){
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();

  // mic
  if(micSource) try{micSource.disconnect();}catch(e){}
  if(!localStream) return;
  micSource = audioCtx.createMediaStreamSource(localStream);
  if(!micGain) micGain = audioCtx.createGain();
  micGain.gain.value = 1;

  // music
  if(musicSource) try{musicSource.disconnect();}catch(e){}
  if(playerEl){
    try{
      musicSource = audioCtx.createMediaElementSource(playerEl);
    }catch(e){
      // –µ—Å–ª–∏ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω ‚Äî –æ–∫
    }
    if(!musicGain) musicGain = audioCtx.createGain();
    musicGain.gain.value = 1;
  }

  if(mixDest) try{mixDest.disconnect();}catch(e){}
  mixDest = audioCtx.createMediaStreamDestination();

  micSource.connect(micGain).connect(mixDest);
  if(musicSource){
    musicSource.connect(musicGain).connect(mixDest);
    try{ musicSource.connect(audioCtx.destination); }catch(e){}
  }
}

function routeMixIntoCall(call){
  if(!mixDest) return;
  const mixTrack = mixDest.stream.getAudioTracks()[0];
  if(!mixTrack) return;
  const senders = call.peerConnection.getSenders();
  const audioSender = senders.find(s=>s.track && s.track.kind==='audio');
  if(audioSender){
    audioSender.replaceTrack(mixTrack).catch(()=>{});
    musicSender=audioSender;
  }else{
    musicSender = call.peerConnection.addTrack(mixTrack, mixDest.stream);
  }
}

/* ------------------ PEER FLOW ------------------ */
function showShare(code){
  $('sharePanel').style.display='flex';
  const link = `${location.origin}/room.html?join=${encodeURIComponent(code)}`;
  $('shareCode').textContent = link;
  const btn = $('copyBtn');
  btn.style.display='inline-block';
  btn.onclick = async ()=>{
    try{
      await navigator.clipboard.writeText(link);
      btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úì';
      setTimeout(()=>btn.textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É', 1500);
    }catch{
      const r=document.createRange(); r.selectNodeContents($('shareCode'));
      const s=window.getSelection(); s.removeAllRanges(); s.addRange(r);
    }
  };
}

function bindStreamHandlers(call){
  call.on('stream', rs=>{
    remoteStream=rs;
    $('remoteVideo').srcObject=rs;
    $('remoteState').textContent='–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
  });
  call.on('close', ()=>{$('remoteState').textContent='–°–≤—è–∑—å –∑–∞–∫–æ–Ω—á–µ–Ω–∞';});
  call.on('error', e=>{console.error(e); $('remoteState').textContent='–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';});
}

function bindHandlersAsHost(){
  peer.on('call', call=>{
    currentCall=call;
    call.answer(localStream);
    bindStreamHandlers(call);
    routeMixIntoCall(call); // ‚Üê –∫–ª–∞–¥—ë–º –º–∏–∫—Å
  });
}

function connectAsStudent(code){
  $('sharePanel').style.display='none';
  $('remoteState').textContent='–ò–¥—ë—Ç –∑–≤–æ–Ω–æ–∫ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—é‚Ä¶';
  const call = peer.call(code, localStream);
  currentCall=call;
  bindStreamHandlers(call);
  routeMixIntoCall(call); // ‚Üê –∫–ª–∞–¥—ë–º –º–∏–∫—Å
}

/* ------------------ –ü–†–ê–í–ê –î–û–°–¢–£–ü–ê ------------------ */
const isIOS = /iP(ad|hone|od)/.test(navigator.userAgent) || (navigator.platform==='MacIntel' && navigator.maxTouchPoints>1);

async function checkPermissions(){
  if (!navigator.permissions) { $('permPanel').style.display='flex'; return 'prompt'; }
  try{
    const mic = await navigator.permissions.query({name:'microphone'});
    const cam = await navigator.permissions.query({name:'camera'});
    if (mic.state==='granted' && cam.state==='granted') return 'granted';
    $('permPanel').style.display='flex';
    return (mic.state==='denied'||cam.state==='denied')?'denied':'prompt';
  }catch{
    $('permPanel').style.display='flex'; return 'prompt';
  }
}

async function requestAccess(){
  try{
    await getMedia();
    $('permPanel').style.display='none';
    if(!peer) await initPeerFlow();
  }catch(e){
    console.error(e);
    $('permText').textContent='–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞/–±—Ä–∞—É–∑–µ—Ä–∞.';
    if (isIOS) {
      $('permText').textContent = '–ß—Ç–æ–±—ã —Ä–∞–∑—Ä–µ—à–∏—Ç—å: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí Safari ‚Üí –ú–∏–∫—Ä–æ—Ñ–æ–Ω/–ö–∞–º–µ—Ä–∞ ‚Üí –†–∞–∑—Ä–µ—à–∏—Ç—å, –∑–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
    }
  }
}

async function initPeerFlow(){
  peer = new Peer(); // –æ–±–ª–∞—á–Ω—ã–π PeerJS
  if(isHost){
    peer.on('open', ()=>{
      const code = GEN();
      peer.destroy(); peer = new Peer(code);
      peer.on('open', ()=> showShare(code));
      bindHandlersAsHost();
    });
  }else if(joinId){
    peer.on('open', ()=> connectAsStudent(joinId));
  }else{
    location.href='/';
  }
}

/* ------------------ –ü–õ–ï–ô–õ–ò–°–¢ ------------------ */
const playlist = $('playlist');
const hiddenPlayer = $('hiddenPlayer');
let tracks=[];

function fmt(t){ // —Å–µ–∫ -> –º–º:—Å—Å
  if(!isFinite(t)) return '0:00';
  const m = Math.floor(t/60), s = Math.floor(t%60).toString().padStart(2,'0');
  return `${m}:${s}`;
}

function renderList(){
  playlist.innerHTML='';
  tracks.forEach((tr,idx)=>{
    const row=document.createElement('div'); row.className='track';

    const play=document.createElement('button'); play.className='iconbtn'; play.innerHTML='‚ñ∂Ô∏é';
    const name=document.createElement('div'); name.className='name'; name.title=tr.file.name; name.textContent=tr.file.name;
    const block=document.createElement('div'); block.style.minWidth='140px'; block.className='row';

    const timeL=document.createElement('span'); timeL.className='time'; timeL.textContent='0:00';
    const range=document.createElement('input'); range.type='range'; range.min=0; range.max=1000; range.value=0; range.className='bar';
    const timeR=document.createElement('span'); timeR.className='time'; timeR.textContent='0:00';

    block.append(timeL,range,timeR);
    row.append(play,name,block);
    playlist.append(row);

    // —Å–æ–±—ã—Ç–∏–µ Play/Pause
    play.onclick = async ()=>{
      // –µ—Å–ª–∏ —É–∂–µ —ç—Ç–æ—Ç –∏–≥—Ä–∞–µ—Ç ‚Äî –ø–∞—É–∑–∞
      if(hiddenPlayer.srcObject===tr.src || hiddenPlayer.currentSrc===tr.url){
        if(hiddenPlayer.paused){ await hiddenPlayer.play(); play.innerHTML='‚è∏'; }
        else{ hiddenPlayer.pause(); play.innerHTML='‚ñ∂Ô∏é'; }
        return;
      }
      // –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —ç—Ç–æ—Ç —Ç—Ä–µ–∫
      if (tr.url) hiddenPlayer.src = tr.url;
      else { hiddenPlayer.srcObject = tr.src; }
      hiddenPlayer.currentTime=0;
      try{
        await hiddenPlayer.play();
        play.innerHTML='‚è∏';
        // –ø–æ–¥–∫–ª—é—á–∏—Ç—å –ø–ª–µ–µ—Ä –≤ –º–∏–∫—à–µ—Ä –∏ –≤ –∑–≤–æ–Ω–æ–∫
        rebuildAudioMixer(hiddenPlayer);
        if(currentCall) routeMixIntoCall(currentCall);
      }catch(e){ console.error(e); }
    };

    // –ø—Ä–æ–≥—Ä–µ—Å—Å/–ø–µ—Ä–µ–º–æ—Ç–∫–∞
    hiddenPlayer.addEventListener('timeupdate', ()=>{
      if (hiddenPlayer.src===tr.url || hiddenPlayer.srcObject===tr.src) {
        const c=hiddenPlayer.currentTime, d=hiddenPlayer.duration||1;
        timeL.textContent=fmt(c);
        timeR.textContent=fmt(d);
        range.value=Math.floor(c/d*1000);
      }
    });
    range.oninput = ()=>{
      if(hiddenPlayer.src===tr.url || hiddenPlayer.srcObject===tr.src){
        const d=hiddenPlayer.duration||1;
        hiddenPlayer.currentTime = (range.value/1000)*d;
      }
    };
    hiddenPlayer.addEventListener('ended', ()=>{ if(hiddenPlayer.src===tr.url || hiddenPlayer.srcObject===tr.src){ play.innerHTML='‚ñ∂Ô∏é'; }});
  });
}

$('fileInput').onchange = async (e)=>{
  const files=[...e.target.files];
  for(const f of files){
    const url=URL.createObjectURL(f);
    tracks.push({file:f,url});
  }
  renderList();
};
$('clearBtn').onclick = ()=>{
  tracks=[]; hiddenPlayer.pause(); hiddenPlayer.removeAttribute('src'); hiddenPlayer.srcObject=null; renderList();
};

/* ------------------ INIT ------------------ */
async function init(){
  // —Ä–æ–ª—å/–ø—Ä–∞–≤–∞
  if(isHost) $('sharePanel').style.display='flex';
  const status = await checkPermissions();
  $('askBtn').onclick = requestAccess;
  if (status==='granted'){ await requestAccess(); }

  // –∫–Ω–æ–ø–∫–∏
  $('micBtn').onclick = ()=> setMic(!(localStream?.getAudioTracks()[0]?.enabled));
  $('camBtn').onclick = ()=> setCam(!(localStream?.getVideoTracks()[0]?.enabled));
  $('musicMode').onchange = async (e)=>{
    musicEnabled = e.target.checked;
    await getMedia();
    if(currentCall) routeMixIntoCall(currentCall);
  };
  $('sidetone').onchange = (e)=> toggleSidetone(e.target.checked);
}

init();
</script>
</body>
</html>
