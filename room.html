<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Muzroom Pro ‚Äî –ö–æ–º–Ω–∞—Ç–∞</title>
<link rel="icon" href="/favicon.ico">
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
  :root{
    --bg:#f6f8fb; --paper:#fff; --ink:#1f2430; --muted:#5b657a;
    --accent:#2e3543; --accent-weak:#e7eaf2; --ring:0 0 0 4px rgba(46,53,67,.15);
    --shadow:0 12px 28px rgba(16,20,32,.08); --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg)}
  header,footer{max-width:1100px;margin:0 auto;padding:16px 14px}
  header a{color:var(--ink);text-decoration:none;font-weight:700;display:flex;align-items:center;gap:10px}
  .logo{width:32px;height:32px;border-radius:999px;background:conic-gradient(from 210deg,#2e3543,#4a5469,#2e3543);display:grid;place-items:center;color:#fff}
  main{max-width:1100px;margin:0 auto;padding:12px 14px 26px;display:grid;gap:12px}
  .panel{background:var(--paper);border:1px solid var(--accent-weak);border-radius:16px;box-shadow:var(--shadow);padding:12px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:12px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
  .muted{color:var(--muted)}
  .code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f0f3fa;border:1px dashed #cdd5e6;border-radius:12px;padding:10px 12px;word-break:break-all}
  .btn{appearance:none;border:none;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer;transition:.25s;outline:none}
  .btn:focus-visible{box-shadow:var(--ring)}
  .btn-main{background:var(--accent);color:#fff}
  .btn-main:hover{box-shadow:0 10px 18px rgba(46,53,67,.18);background:#262c38}
  .btn-ghost{background:#fff;border:1px solid var(--accent-weak);color:#1f2430}
  video,.audio{width:100%;background:#0b0f1a;border-radius:12px}

  /* —Å–µ–ª–µ–∫—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
  .devRow{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  select{padding:10px 12px;border-radius:10px;border:1px solid #dce3f2;background:#fff}
  label{color:var(--muted);font-size:14px}

  /* –ø–ª–µ–µ—Ä —É—Å—Ç–æ–π—á–∏–≤—ã–π */
  .playlist{list-style:none;padding:0;margin:0;display:grid;gap:10px}
  .track{background:#fff;border:1px solid #e7eaf2;border-radius:12px;padding:10px}
  .title{max-width:100%;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;font-weight:600;margin-bottom:6px}
  .playerRow{display:grid;grid-template-columns:44px 1fr 160px;gap:10px;align-items:center}
  @media(max-width:680px){.playerRow{grid-template-columns:44px 1fr;grid-template-rows:auto auto}}
  .play{width:44px;height:44px;border-radius:50%;border:none;background:var(--accent);color:#fff;display:grid;place-items:center;font-size:18px}
  .progress{-webkit-appearance:none;appearance:none;width:100%;height:10px;background:#e9edf6;border-radius:999px;outline:none}
  .progress::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--accent);border:none;margin-top:-4px}
  .volume{-webkit-appearance:none;appearance:none;height:10px;width:160px;background:#e9edf6;border-radius:999px;outline:none}
  .volume::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent);border:none;margin-top:-3px}
  .meta{font-size:12px;color:#5b657a}
</style>
</head>
<body>
<header>
  <a href="/"><span class="logo">–ú</span> Muzroom Pro</a>
</header>

<main>
  <!-- –ø–∞–Ω–µ–ª—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è: —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É + —Å–∞–º–∞ —Å—Å—ã–ª–∫–∞ -->
  <section class="panel" id="hostPanel" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="code" id="shareCode" style="flex:1;min-width:240px">–°—Å—ã–ª–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞</div>
      <div class="row">
        <button class="btn btn-ghost" id="createLinkBtn">–°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
        <button class="btn btn-ghost" id="copyBtn" disabled>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>
  </section>

  <!-- —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è -->
  <section class="panel row" id="permPanel" style="display:none;justify-content:space-between;align-items:flex-start">
    <div class="muted" id="permText">
      –ß—Ç–æ–±—ã —Ä–∞–∑—Ä–µ—à–∏—Ç—å: <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí Safari ‚Üí –ú–∏–∫—Ä–æ—Ñ–æ–Ω ‚Üí –†–∞–∑—Ä–µ—à–∏—Ç—å</b>, <b>–ö–∞–º–µ—Ä–∞ ‚Üí –†–∞–∑—Ä–µ—à–∏—Ç—å</b>, –∑–∞—Ç–µ–º –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.
    </div>
    <button class="btn btn-main" id="askBtn">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
  </section>

  <!-- —Å–µ–ª–µ–∫—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–≤—Ö–æ–¥—ã –∞—É–¥–∏–æ) -->
  <section class="panel">
    <div class="devRow">
      <label for="micSelect">–í—Ö–æ–¥ (–º–∏–∫—Ä–æ—Ñ–æ–Ω/–∞—É–¥–∏–æ–∫–∞—Ä—Ç–∞):</label>
      <select id="micSelect" style="min-width:260px"></select>
      <button class="btn btn-ghost" id="refreshDevs">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
      <div class="muted" id="devHelp" style="font-size:12px">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∞—É–¥–∏–æ–∫–∞—Ä—Ç—É/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∑–∞—Ç–µ–º ¬´–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫¬ª.</div>
    </div>
  </section>

  <!-- –≤–∏–¥–µ–æ -->
  <section class="grid">
    <div class="panel">
      <video id="remoteVideo" autoplay playsinline></video>
      <div class="muted" id="remoteState" style="margin-top:6px">–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è‚Ä¶</div>
    </div>
    <div class="panel">
      <video id="localVideo" autoplay playsinline muted></video>
      <div class="row" style="margin-top:8px">
        <button class="btn btn-main" id="micBtn">üéôÔ∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω: –í–∫–ª</button>
        <button class="btn btn-ghost" id="camBtn">üì∑ –ö–∞–º–µ—Ä–∞: –í–∫–ª</button>
      </div>
      <div class="row" style="margin-top:6px">
        <label><input id="musicMode" type="checkbox" checked> –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º (–±–µ–∑ —à—É–º–æ–¥–∞–≤–∞)</label>
        <label><input id="sidetone" type="checkbox"> –°–ª—ã—à–∞—Ç—å —Å–µ–±—è</label>
      </div>
      <audio id="monitor" class="audio" controls hidden></audio>
    </div>
  </section>

  <!-- –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã -->
  <section class="panel">
    <div class="muted" style="margin-bottom:8px">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–∏ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã</div>
    <div class="row">
      <!-- –≤–∞–∂–Ω–æ–µ: —Ä–µ–∞–ª—å–Ω—ã–π input –Ω–µ —Å–∫—Ä—ã–≤–∞–µ–º display:none -->
      <div style="position:relative;display:inline-block">
        <span class="btn btn-ghost">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</span>
        <input id="fileInput" type="file" multiple accept="audio/*"
               style="position:absolute;inset:0;opacity:0;cursor:pointer">
      </div>
      <button class="btn btn-ghost" id="clearPl">–û—á–∏—Å—Ç–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç</button>
    </div>
    <ul id="playlist" class="playlist" style="margin-top:10px"></ul>
  </section>
</main>

<footer class="row" style="justify-content:space-between">
  <div class="muted">Muzroom Pro ‚Äî –æ–Ω–ª–∞–π–Ω-–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö —É—Ä–æ–∫–æ–≤</div>
  <div class="muted">¬© 2025 Muzroom Pro ¬∑ <a href="/privacy.html">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a></div>
</footer>

<!-- —Å–∫—Ä—ã—Ç—ã–π –∞—É–¥–∏–æ-—ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è -->
<audio id="hiddenPlayer" crossorigin="anonymous" playsinline></audio>

<script>
/* ====== –±–∞–∑–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ====== */
const $ = id => document.getElementById(id);
const qp = new URLSearchParams(location.search);
const isHost = qp.has('host');
const joinId = qp.get('join') || null;
const GEN = () => Math.random().toString(36).slice(2,8).toUpperCase();

let localStream=null, remoteStream=null, peer=null, currentCall=null;
let musicEnabled=true, monitorStarted=false;
let chosenDeviceId=null; // –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤—Ö–æ–¥

/* WebAudio –º–∏–∫—à–µ—Ä */
let audioCtx=null, micSource=null, micGain=null, musicSource=null, musicGain=null, mixDest=null;

/* ====== RTC —Å TURN (—Å—Ç–∞–±–∏–ª—å–Ω–æ —á–µ—Ä–µ–∑ –º–æ–±–∏–ª—å–Ω—ã–µ —Å–µ—Ç–∏) ====== */
const rtcCfg = {
  iceServers: [
    {urls:'stun:stun.l.google.com:19302'},
    {urls:'turn:openrelay.metered.ca:80', username:'openrelayproject', credential:'openrelayproject'},
    {urls:'turn:openrelay.metered.ca:443', username:'openrelayproject', credential:'openrelayproject'},
    {urls:'turn:openrelay.metered.ca:443?transport=tcp', username:'openrelayproject', credential:'openrelayproject'}
  ]
};
function newPeer(id){ return id ? new Peer(id,{config:rtcCfg}) : new Peer(undefined,{config:rtcCfg}); }

/* ====== –º–µ–¥–∏–∞ ====== */
function getAudioConstraints(){
  const base = {
    channelCount: 2,
    sampleRate: 48000,
    echoCancellation: !musicEnabled,
    noiseSuppression: !musicEnabled,
    autoGainControl: !musicEnabled
  };
  if (chosenDeviceId) base.deviceId = {exact: chosenDeviceId};
  return { audio: base, video: true };
}

async function getMedia(){
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  localStream = await navigator.mediaDevices.getUserMedia(getAudioConstraints());
  $('localVideo').srcObject = localStream;
  rebuildAudioMixer($('hiddenPlayer')); // —Å–æ–±—Ä–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –º–∏–∫—à–µ—Ä
  return localStream;
}

function setMic(on){
  localStream?.getAudioTracks().forEach(t=>t.enabled=on); // –¥–ª—è –ø—Ä–µ–≤—å—é
  if (micGain) micGain.gain.value = on ? 1 : 0;           // –≤ –º–∏–∫—Å–µ
  $('micBtn').textContent = `üéôÔ∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω: ${on?'–í–∫–ª':'–í—ã–∫–ª'}`;
}
function setCam(on){
  localStream?.getVideoTracks().forEach(t=>t.enabled=on);
  $('camBtn').textContent = `üì∑ –ö–∞–º–µ—Ä–∞: ${on?'–í–∫–ª':'–í—ã–∫–ª'}`;
}
function toggleSidetone(on){
  const a=$('monitor');
  if(on && !monitorStarted){ a.hidden=false; a.srcObject=localStream; a.muted=false; a.play().catch(()=>{}); monitorStarted=true; }
  if(!on && monitorStarted){ a.pause(); a.srcObject=null; a.hidden=true; monitorStarted=false; }
}

/* ====== —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–º–∏–∫—Ä–æ—Ñ–æ–Ω—ã/–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã) ====== */
async function listDevices(){
  // –Ω—É–∂–µ–Ω gUM —Ö–æ—Ç—è –±—ã —Ä–∞–∑, —á—Ç–æ–±—ã –ø–æ—è–≤–∏–ª–∏—Å—å –º–µ—Ç–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
  try{ await navigator.mediaDevices.getUserMedia({audio:true, video:false}); }catch(_){}
  const devs = await navigator.mediaDevices.enumerateDevices();
  const mics = devs.filter(d=>d.kind==='audioinput');
  const sel = $('micSelect'); sel.innerHTML='';
  mics.forEach((d,idx)=>{
    const o=document.createElement('option');
    o.value=d.deviceId; o.textContent=d.label||`–ú–∏–∫—Ä–æ—Ñ–æ–Ω ${idx+1}`;
    sel.appendChild(o);
  });
  // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ
  if (chosenDeviceId && [...sel.options].some(o=>o.value===chosenDeviceId)) {
    sel.value = chosenDeviceId;
  } else {
    chosenDeviceId = sel.value || null;
  }
}
$('refreshDevs').onclick = listDevices;
$('micSelect').onchange = async (e)=>{
  chosenDeviceId = e.target.value || null;
  await getMedia();
  if(currentCall) routeMixIntoCall(currentCall);
};

/* ====== –º–∏–∫—à–µ—Ä (–º–∏–∫ + –ø–ª–µ–µ—Ä -> –æ–¥–∏–Ω —Ç—Ä–µ–∫ –≤ –∑–≤–æ–Ω–æ–∫) ====== */
function rebuildAudioMixer(playerEl){
  if(!localStream) return;
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();

  if(micSource) try{micSource.disconnect();}catch(_){}
  micSource = audioCtx.createMediaStreamSource(localStream);
  if(!micGain) micGain = audioCtx.createGain();
  micGain.gain.value = 1;

  if(playerEl){
    if(!musicGain) musicGain = audioCtx.createGain();
    musicGain.gain.value = 1;
    try{
      if(musicSource) musicSource.disconnect();
      musicSource = audioCtx.createMediaElementSource(playerEl);
    }catch(_){/* –µ—Å–ª–∏ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω ‚Äî –æ–∫ */}    
  }

  if(mixDest) try{mixDest.disconnect();}catch(_){}
  mixDest = audioCtx.createMediaStreamDestination();

  micSource.connect(micGain).connect(mixDest);
  if(musicSource){
    musicSource.connect(musicGain).connect(mixDest);
    try{ musicSource.connect(audioCtx.destination); }catch(_){}
  }
}

function routeMixIntoCall(call){
  if(!mixDest) return;
  const mixTrack = mixDest.stream.getAudioTracks()[0];
  if(!mixTrack) return;
  const snd = call.peerConnection.getSenders().find(s=>s.track&&s.track.kind==='audio');
  if(snd){ snd.replaceTrack(mixTrack).catch(()=>{}); }
  else   { call.peerConnection.addTrack(mixTrack, mixDest.stream); }
}

/* ====== Peer / —Å—Å—ã–ª–∫–∞ / –∑–≤–æ–Ω–æ–∫ ====== */
let peerObj = null; // —Ç–µ–∫—É—â–∏–π Peer (–¥–ª—è –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è —Å –∫–æ–¥–æ–º)

async function forceCreateLink(){
  // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –º–µ–¥–∏–∞ (–∏–Ω–∞—á–µ –≤ iOS —Å–µ–ª–µ–∫—Ç –±–µ–∑ –º–µ—Ç–æ–∫)
  await getMedia();
  if (peerObj) { try{ peerObj.destroy(); }catch(_){} }
  // —Å–æ–∑–¥–∞—ë–º –∫—Ä–∞—Å–∏–≤—ã–π –∫–æ–¥
  const code = GEN();
  peerObj = newPeer(code);
  peerObj.on('open', ()=>{
    showLink(code);
    bindHandlersAsHost(peerObj);
  });
}

function showLink(code){
  const link = `${location.origin}/room.html?join=${encodeURIComponent(code)}`;
  $('shareCode').textContent = link;
  const btn=$('copyBtn'); btn.disabled=false;
  btn.onclick = async ()=>{
    try{ await navigator.clipboard.writeText(link); btn.textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úì'; setTimeout(()=>btn.textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å',1200); }
    catch{ const r=document.createRange(); r.selectNodeContents($('shareCode')); const s=window.getSelection(); s.removeAllRanges(); s.addRange(r); }
  };
}

function bindHandlersAsHost(p){
  p.on('call', call=>{
    currentCall=call;
    call.answer(localStream);
    bindStreamHandlers(call);
    routeMixIntoCall(call);
  });
}

function startAsStudent(code){
  peerObj = newPeer();
  peerObj.on('open', ()=>{
    const call = peerObj.call(code, localStream);
    currentCall = call;
    bindStreamHandlers(call);
    routeMixIntoCall(call);
  });
}

function bindStreamHandlers(call){
  call.on('stream', rs=>{ remoteStream=rs; $('remoteVideo').srcObject=rs; $('remoteState').textContent='–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'; });
  call.on('close', ()=>{ $('remoteState').textContent='–°–≤—è–∑—å –∑–∞–∫–æ–Ω—á–µ–Ω–∞'; });
  call.on('error', e=>{ console.error(e); $('remoteState').textContent='–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'; });
}

/* ====== —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è ====== */
async function checkPermissions(){
  if(!navigator.permissions){ $('permPanel').style.display='flex'; return 'prompt'; }
  try{
    const m=await navigator.permissions.query({name:'microphone'});
    const c=await navigator.permissions.query({name:'camera'});
    if(m.state==='granted' && c.state==='granted') return 'granted';
    $('permPanel').style.display='flex';
    return (m.state==='denied'||c.state==='denied')?'denied':'prompt';
  }catch{
    $('permPanel').style.display='flex'; return 'prompt';
  }
}
async function requestAccess(){
  try{
    await getMedia();
    $('permPanel').style.display='none';
    await listDevices();
    if(!isHost && joinId){ startAsStudent(joinId); }
  }catch(e){
    console.error(e);
    alert('–ß—Ç–æ–±—ã —Ä–∞–∑—Ä–µ—à–∏—Ç—å: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí Safari ‚Üí –ú–∏–∫—Ä–æ—Ñ–æ–Ω ‚Üí –†–∞–∑—Ä–µ—à–∏—Ç—å; –ö–∞–º–µ—Ä–∞ ‚Üí –†–∞–∑—Ä–µ—à–∏—Ç—å. –ó–∞—Ç–µ–º –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —Å–Ω–æ–≤–∞.');
  }
}
$('askBtn').onclick = requestAccess;

/* ====== –ø–ª–µ–µ—Ä (—É—Å—Ç–æ–π—á–∏–≤—ã–π) ====== */
const fileInput = $('fileInput'), playlistEl = $('playlist'), hiddenPlayer=$('hiddenPlayer');
let tracks=[]; let current=-1;

fileInput.onchange = async (e)=>{
  const files = Array.from(e.target.files||[]);
  for(const f of files){
    if(!f.type.startsWith('audio/')) continue;
    const url = URL.createObjectURL(f);
    const a = new Audio(url); a.preload='metadata';
    await new Promise(res=>{ a.addEventListener('loadedmetadata',res,{once:true}); setTimeout(res,700); });
    tracks.push({name:f.name, url, audio:a, dur:a.duration||0});
  }
  renderPlaylist();
  fileInput.value='';
};
$('clearPl').onclick = ()=>{
  tracks.forEach(t=>URL.revokeObjectURL(t.url));
  tracks=[]; current=-1; renderPlaylist();
};

function shortName(name){
  const isMob = matchMedia('(max-width:680px)').matches;
  if(!isMob) return name;
  const base = name.replace(/\.[a-z0-9]+$/i,'');
  const ext  = (name.match(/\.[a-z0-9]+$/i)||[''])[0];
  if(base.length<=12) return name;
  return base.slice(0,12)+'‚Ä¶'+ext;
}
function fmt(sec){ sec=Math.max(0, sec|0); const m=(sec/60)|0, s=(sec%60)|0; return `${m}:${s.toString().padStart(2,'0')}`; }
function esc(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

function renderPlaylist(){
  playlistEl.innerHTML='';
  tracks.forEach((t,i)=>{
    const li=document.createElement('li'); li.className='track';
    li.innerHTML=`
      <div class="title" title="${esc(t.name)}">${esc(shortName(t.name))}</div>
      <div class="playerRow">
        <button class="play" data-i="${i}" aria-label="Play/Pause">‚ñ∂</button>
        <input class="progress" type="range" min="0" max="${t.dur||1}" step="0.01" value="0" data-i="${i}">
        <input class="volume" type="range" min="0" max="1" step="0.01" value="1" data-i="${i}">
      </div>
      <div class="meta" id="meta-${i}">${fmt(0)} / ${fmt(t.dur)}</div>
    `;
    playlistEl.appendChild(li);
  });
  bindPlayerEvents();
}

function bindPlayerEvents(){
  playlistEl.querySelectorAll('.play').forEach(btn=>{
    btn.onclick=()=>togglePlay(+btn.dataset.i);
  });
  playlistEl.querySelectorAll('.progress').forEach(sl=>{
    sl.oninput=()=>{
      const i=+sl.dataset.i, t=tracks[i]; if(!t) return;
      t.audio.currentTime = +sl.value;
      updateMeta(i);
    };
  });
  playlistEl.querySelectorAll('.volume').forEach(sl=>{
    sl.oninput=()=>{
      const i=+sl.dataset.i, t=tracks[i]; if(!t) return;
      t.audio.volume = +sl.value;
    };
  });
}

function togglePlay(i){
  const t=tracks[i]; if(!t) return;

  if(current!==-1 && current!==i){
    const p=tracks[current]; p.audio.pause(); setBtn(current,false);
  }
  current=i;

  // –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –≤ —Å–∫—Ä—ã—Ç–æ–º –ø–ª–µ–µ—Ä–µ –¥–ª—è –º–∏–∫—à–µ—Ä–∞
  if(hiddenPlayer.src!==t.url){ hiddenPlayer.src=t.url; hiddenPlayer.currentTime=0; }

  if(t.audio.paused){
    t.audio.play().catch(console.warn);
    hiddenPlayer.play().catch(()=>{}); // —á—Ç–æ–±—ã AudioContext ¬´–ø—Ä–æ—Å–Ω—É–ª—Å—è¬ª
    setBtn(i,true);
    rebuildAudioMixer(hiddenPlayer);
    if(currentCall) routeMixIntoCall(currentCall);
  }else{
    t.audio.pause(); hiddenPlayer.pause(); setBtn(i,false);
  }

  t.audio.ontimeupdate = ()=>{
    const prog=playlistEl.querySelector(`.progress[data-i="${i}"]`);
    if(prog && !isNaN(t.audio.currentTime)) prog.value=t.audio.currentTime;
    updateMeta(i);
  };
  t.audio.onended = ()=>{ setBtn(i,false); };
}
function setBtn(i,playing){
  const b=playlistEl.querySelector(`.play[data-i="${i}"]`);
  if(b) b.textContent = playing?'‚è∏':'‚ñ∂';
}
function updateMeta(i){
  const t=tracks[i]; if(!t) return;
  const m=$('meta-'+i);
  if(m) m.textContent = `${fmt(t.audio.currentTime||0)} / ${fmt(t.dur||0)}`;
}

/* ====== init ====== */
(async function init(){
  if(isHost){
    $('hostPanel').style.display='block';
    $('createLinkBtn').onclick = forceCreateLink; // —è–≤–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
  }

  $('micBtn').onclick = ()=> setMic(!(localStream?.getAudioTracks()[0]?.enabled));
  $('camBtn').onclick = ()=> setCam(!(localStream?.getVideoTracks()[0]?.enabled));
  $('musicMode').onchange = async (e)=>{ musicEnabled = e.target.checked; await getMedia(); if(currentCall) routeMixIntoCall(currentCall); };
  $('sidetone').onchange = (e)=> toggleSidetone(e.target.checked);

  const status = await checkPermissions();
  if(status==='granted'){
    await requestAccess();     // –ø–æ–ª—É—á–∏–º –º–µ–¥–∏–∞, –∑–∞–ø–æ–ª–Ω–∏–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    if(isHost){
      // –∞–≤—Ç–æ —Å–æ–∑–¥–∞–¥–∏–º —Å—Å—ã–ª–∫—É, –Ω–æ –æ—Å—Ç–∞–≤–∏–ª–∏ –∫–Ω–æ–ø–∫—É –Ω–∞ —Å–ª—É—á–∞–π —Å–±–æ–µ–≤
      forceCreateLink();
    }
  }else{
    $('permPanel').style.display='flex';
  }
})();
</script>
</body>
</html>
